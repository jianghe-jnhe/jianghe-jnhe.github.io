<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>MLX90640中文API | Jnhe</title>
  <meta name="description" content="1. 概述为了使用MLX90640驱动程序，C项目中应该包含4个文件:  MLX90640_I2C_Driver.h — 包含I2C相关函数定义的头文件 MLX90640_API.h — 包含MLX90640特定函数定义的头文件 MLX90640_API.c —包含MLX90640特定功能的文件（原文是MLX90640_API.cpp） （原文中只有3个文件，这里说4个文件，应该是指需要一个MCU">
<meta property="og:type" content="article">
<meta property="og:title" content="MLX90640中文API">
<meta property="og:url" content="https://jianghe-jnhe.github.io/2024/10/04/MLX90640/index.html">
<meta property="og:site_name" content="Jnhe">
<meta property="og:description" content="1. 概述为了使用MLX90640驱动程序，C项目中应该包含4个文件:  MLX90640_I2C_Driver.h — 包含I2C相关函数定义的头文件 MLX90640_API.h — 包含MLX90640特定函数定义的头文件 MLX90640_API.c —包含MLX90640特定功能的文件（原文是MLX90640_API.cpp） （原文中只有3个文件，这里说4个文件，应该是指需要一个MCU">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-10-04T08:26:56.000Z">
<meta property="article:modified_time" content="2024-10-04T13:04:24.972Z">
<meta property="article:author" content="Jnhe">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://jianghe-jnhe.github.io/2024/10/04/MLX90640/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Jnhe" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 7.0.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/jianghe-jnhe" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">JiangHe</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Student</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> GuangXi, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/jianghe-jnhe" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://space.bilibili.com/496375938" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>不打鸡血，不摆烂</p>
            </div>
        </div>
    </div>
</div>

    
      

    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E9%A9%B1%E5%8A%A8/" rel="tag">Linux驱动</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/QT/" rel="tag">QT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/C/" style="font-size: 14px;">C</a> <a href="/tags/Linux%E9%A9%B1%E5%8A%A8/" style="font-size: 13.5px;">Linux驱动</a> <a href="/tags/QT/" style="font-size: 13px;">QT</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13px;">操作系统</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">二月 2025</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">十二月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">十月 2024</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2025/02/14/callback/" class="title">multi_button前提知识：回调函数</a>
              </p>
              <p class="item-date">
                <time datetime="2025-02-14T12:40:15.440Z" itemprop="datePublished">2025-02-14</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2025/02/13/multi-button/" class="title">multi_button</a>
              </p>
              <p class="item-date">
                <time datetime="2025-02-13T08:47:43.103Z" itemprop="datePublished">2025-02-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/12/29/ResumeAttachment/" class="title">简历附件</a>
              </p>
              <p class="item-date">
                <time datetime="2024-12-29T13:27:01.653Z" itemprop="datePublished">2024-12-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/10/10/QTLayoutandQSS/" class="title">QT</a>
              </p>
              <p class="item-date">
                <time datetime="2024-10-10T14:15:56.000Z" itemprop="datePublished">2024-10-10</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/10/10/enum-typedef-define/" class="title">enum typedef define</a>
              </p>
              <p class="item-date">
                <time datetime="2024-10-10T05:15:56.000Z" itemprop="datePublished">2024-10-10</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-MLX90640" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      MLX90640中文API
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2024/10/04/MLX90640/" class="article-date">
	  <time datetime="2024-10-04T08:26:56.000Z" itemprop="datePublished">2024-10-04</time>
	</a>
</span>
        
        

        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2024/10/04/MLX90640/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>为了使用MLX90640驱动程序，C项目中应该包含4个文件:</p>
<ul>
<li><em>MLX90640_I2C_Driver.h</em> — 包含I2C相关函数定义的头文件</li>
<li><em>MLX90640_API.h</em> — 包含MLX90640特定函数定义的头文件</li>
<li><em>MLX90640_API.c</em> —包含MLX90640特定功能的文件（原文是<em>MLX90640_API.cpp</em>）</li>
<li>（原文中只有3个文件，这里说4个文件，应该是指需要一个MCU硬件I2C或者软件模拟I2C的C驱动程序，详见第2章）</li>
</ul>
<h2 id="2-I2C驱动"><a href="#2-I2C驱动" class="headerlink" title="2. I2C驱动"></a>2. I2C驱动</h2><p>这是I2C通信的驱动程序。用户应该相应地实现这个驱动程序，以便与MLX90640实现适当的I2C。由于这些函数是由MLX90640 API使用的，因此不应该更改函数定义，函数实现应该使用适当的输入和输出。I2C标准首先读取低字节（LSByte），反转数据的端序。注意，驱动程序还负责重建正确的端序。如果更改了这部分代码，则应注意正确地恢复数据。</p>
<h3 id="2-1-I2C驱动函数"><a href="#2-1-I2C驱动函数" class="headerlink" title="2.1. I2C驱动函数"></a><em>2.1. I2C驱动函数</em></h3><p>I2C驱动有五个主要功能，确保用户MCU和MLX90640之间的正常通信。这些功能的实现需要由用户来完成。但是，保持相同的函数定义非常重要。</p>
<h4 id="2-1-1-void-MLX90640-I2CInit-void"><a href="#2-1-1-void-MLX90640-I2CInit-void" class="headerlink" title="2.1.1. void MLX90640_I2CInit(void)"></a><em>2.1.1. void MLX90640_I2CInit(void)</em></h4><p>如果需要，这个函数应该用于初始化I2C线路(sda和scl)和I2C硬件模块。I2C线路的初始状态应该是高的。在此函数中生成停止条件还允许重置所有可能正在进行的通信。这可以帮助避免由于初始化过程中错误启动I2C序列而导致的通信失败。</p>
<p>例如：</p>
<ol>
<li><p>I2C的初始化应该在程序开始时完成，以确保正确的通信</p>
<p><u>main.c</u></p>
<p>​	…定义的内容…</p>
<p>​	…MCU 初始化</p>
<p>​	<strong>MLX90640_I2CInit();</strong></p>
<p>​	…</p>
<p>​	…MLX90640 通信</p>
<p>​	…用户代码</p>
</li>
</ol>
<h4 id="2-1-2-void-MLX90640-I2CFreqSet-int-freq"><a href="#2-1-2-void-MLX90640-I2CFreqSet-int-freq" class="headerlink" title="2.1.2. void MLX90640_I2CFreqSet(int freq)"></a><em>2.1.2. void MLX90640_I2CFreqSet(int freq)</em></h4><p> 此功能应用于动态更改I2C频率和&#x2F;或粗设置。它有一个int类型的形参。该参数用于设置硬件I2C模块的工作频率，对于软件I2C驱动，用于设置Wait函数的周期数。当使用I2C硬件模块时，MCU供应商提供的库具有集成的频率更改功能。在这种情况下，应该更改MLX90640 I2C驱动程序，以便它使用库函数来设置频率。在软件I2C驱动程序的情况下(当使用两个通用IOs时)，I2CFreqSet函数可以设置一个全局变量，该变量被Wait函数用来设置循环的数量。为了适当地设置频率，用户应该修剪Wait功能，以便在MLX90640设备传输数据时生成的I2C时钟具有所需的频率。  </p>
<p>例如：</p>
<ol>
<li><p>使用硬件I2C模块时，将I2C频率设置为1MHz，读取帧数据:</p>
<p>MLX90640_I2CFreqSet(1000); &#x2F;&#x2F;在这种情况下，MCU供应商提供的库函数要求int值在KHz -&gt; 1000KHz &#x3D; 1MHz</p>
</li>
<li><p>使用软件I2C实现时，将I2C频率设置为400KHz以读取帧数据:</p>
<p>MLX90640_I2CFreqSet(20); &#x2F;&#x2F;根据指令周期和单片机时钟的不同，</p>
<p>​												&#x2F;&#x2F;等待函数中的20个周期导致MLX90640在传输数据时生成的scl频率为400KHz</p>
</li>
</ol>
<h4 id="2-1-3-int-MLX90640-I2CRead-uint8-t-slaveAddr-uint16-t-startAddress-uint16-t-nMemAddressRead-uint16-t-data"><a href="#2-1-3-int-MLX90640-I2CRead-uint8-t-slaveAddr-uint16-t-startAddress-uint16-t-nMemAddressRead-uint16-t-data" class="headerlink" title="2.1.3. int MLX90640_I2CRead(uint8_t slaveAddr,uint16_t startAddress, uint16_t nMemAddressRead, uint16_t *data)"></a><em>2.1.3. int MLX90640_I2CRead(uint8_t slaveAddr,uint16_t startAddress, uint16_t nMemAddressRead, uint16_t *data)</em></h4><p>该函数从给定地址开始从选定的MLX90640设备存储器中读取所需数量的字，并将数据存储在用户定义的MCU存储器位置中。请注意，当I2C读通信正在进行时，地址位置正在自动增加，但是如果发起了新的读通信，地址将被重置。因此，如果应该在多个I2C读命令中转储大内存，则应该特别注意使用适当的起始地址。如果返回值为0，表示通信成功;如果返回值为-1，表示通信过程中发生NACK。该函数需要以下参数:</p>
<ul>
<li><em>uint8_t slaveAddr</em> — MLX90640设备从地址(默认从地址为0x33)</li>
<li><em>uint16_t startAddress</em> — 要从MLX90640存储器中读取的第一个地址。MLX90640 EEPROM位于地址范围0x2400至0x273F, MLX90640 RAM位于地址范围0x0400至0x073F。</li>
<li><em>uint16_t nMemAddressRead</em> — 要从MLX90640存储器中读取的16位字的数目</li>
<li><em>uint16_t *data</em>  — 指向用户想要存储数据的MCU存储器位置的指针</li>
</ul>
<p>例如：</p>
<ol>
<li><p>读取单个EEPROM值- MLX90640设置的MLX90640设备与从地址0x33:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint16_t</span> eeValue;</span><br><span class="line">MLX90640_I2CRead (<span class="number">0x33</span>, <span class="number">0x240C</span>, <span class="number">1</span>, &amp;eeValue); <span class="comment">// EEPROM 0x240C cell值存储在eeValue中</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>读取从地址为0x33的MLX90640设备的整帧数据:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> frameData[<span class="number">832</span>];</span><br><span class="line">MLX90640_I2CRead(<span class="number">0x33</span>, <span class="number">0x0400</span>, <span class="number">832</span>,  frameData);<span class="comment">//帧数据存储在frameData数组中</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-1-4-int-MLX90640-I2CWrite-uint8-t-slaveAddr-uint16-t-writeAddress-uint16-t-data"><a href="#2-1-4-int-MLX90640-I2CWrite-uint8-t-slaveAddr-uint16-t-writeAddress-uint16-t-data" class="headerlink" title="2.1.4. int MLX90640_I2CWrite(uint8_t slaveAddr,uint16_t writeAddress, uint16_t data)"></a><em>2.1.4. int MLX90640_I2CWrite(uint8_t slaveAddr,uint16_t writeAddress, uint16_t data)</em></h4><p>该函数将16位值写入所选MLX90640设备的所需内存地址。该函数在写操作完成后回读数据，如果写成功返回0，如果在通信过程中发生NACK返回-1，如果内存中的数据与预期的数据不相同返回-2。需要设置的参数如下:</p>
<ul>
<li><em>uint8_t slaveAddr</em> — MLX90640设备从地址(默认从地址为0x33)</li>
<li><em>uint16_t writeAddress</em> — 要写入数据的MLX90640内存地址</li>
<li><em>uint16_t data</em> — 要写入MLX90640内存地址的数据</li>
</ul>
<p>例如：</p>
<ol>
<li><p>写入设置- MLX90640设置的MLX90640设备与从地址0x33:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_I2CWrite(<span class="number">0x33</span>, <span class="number">0x800D</span>, <span class="number">0x0901</span>);  <span class="comment">//所需的设置被写入地址0x800D</span></span><br><span class="line"><span class="comment">//如果写入成功，变量状态为0。</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-1-5-int-MLX90640-I2CGeneralReset-void"><a href="#2-1-5-int-MLX90640-I2CGeneralReset-void" class="headerlink" title="2.1.5.  int MLX90640_I2CGeneralReset(void)"></a><em>2.1.5.  int MLX90640_I2CGeneralReset(void)</em></h4><p>这个函数应该实现I2C的标准复位条件。根据I2C规范，复位条件是发送0x06到地址0x00。如果通信成功，该函数返回0;如果在通信过程中发生了NAK，则返回-1。注意，这个函数将重置总线上支持它的所有设备。</p>
<p>例如：</p>
<ol>
<li><p>复位总线上的所有设备:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_I2CGeneralReset();  <span class="comment">//复位MLX90640设备</span></span><br><span class="line"><span class="comment">//如果通信成功，变量状态为0。</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="3-MLX90640-API"><a href="#3-MLX90640-API" class="headerlink" title="3. MLX90640 API"></a>3. MLX90640 API</h2><p>这是MLX90640设备的驱动程序。用户不应该更改这个驱动程序。</p>
<h3 id="3-1-MLX90640-配置函数"><a href="#3-1-MLX90640-配置函数" class="headerlink" title="3.1. MLX90640 配置函数"></a><em>3.1. MLX90640 配置函数</em></h3><h4 id="3-1-1-int-MLX90640-SetResolution-uint8-t-slaveAddr-uint8-t-resolution"><a href="#3-1-1-int-MLX90640-SetResolution-uint8-t-slaveAddr-uint8-t-resolution" class="headerlink" title="3.1.1. int MLX90640_SetResolution(uint8_t slaveAddr, uint8_t resolution);"></a><em>3.1.1. int MLX90640_SetResolution(uint8_t slaveAddr, uint8_t resolution);</em></h4><p>该函数在适当的寄存器中写入所需的分辨率值(0x00到0x03)，以便更改具有给定从地址的MLX90640设备的当前分辨率。注意，上电复位后，分辨率将恢复到存储在EEPROM中的分辨率。如果写入成功，返回值为0，如果通信过程中发生NACK，返回值为-1，如果写入值与预期值不相同，返回值为-2。</p>
<ul>
<li></li>
<li><em>uint8_t resolution</em> — MLX90640的当前分辨率<ul>
<li>0x00 - 16位分辨率</li>
<li>0x01 - 17位分辨率</li>
<li>0x02 - 18位分辨率</li>
<li>0x03 - 19位分辨率</li>
</ul>
</li>
</ul>
<p>例如：</p>
<ol>
<li><p>设置从地址0x33的MLX90640设备以19位分辨率工作:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Int status;</span><br><span class="line">status = MLX90640_SetResolution (<span class="number">0x33</span>,<span class="number">0x03</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-1-2-int-MLX90640-GetCurResolution-uint8-t-slaveAddr"><a href="#3-1-2-int-MLX90640-GetCurResolution-uint8-t-slaveAddr" class="headerlink" title="3.1.2. int MLX90640_GetCurResolution(uint8_t slaveAddr);"></a><em>3.1.2. int MLX90640_GetCurResolution(uint8_t slaveAddr);</em></h4><p>该函数返回具有给定从属地址的MLX90640设备的当前分辨率。请注意，当前分辨率可能与该设备的EEPROM中设置的分辨率不同。如果结果为-1，说明在通信过程中发生了NACK，这不是一个有效的解析数据。</p>
<ul>
<li><em>uint8_t slaveAddr</em> — MLX90640设备从地址(默认从地址为0x33)</li>
</ul>
<p>例如：</p>
<ol>
<li><p>从从地址0x33的MLX90640设备获取当前分辨率，该设备使用19位分辨率，但在EEPROM中编程为16位分辨率:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> curResolution;</span><br><span class="line">curResolution = MLX90640_GetCurResolution (<span class="number">0x33</span>); </span><br><span class="line"><span class="comment">//curResolution = 0x03(19位)，因为这是设备正在使用的实际分辨率</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-1-3-int-MLX90640-SetRefreshRate-uint8-t-slaveAddr-uint8-t-refreshRate"><a href="#3-1-3-int-MLX90640-SetRefreshRate-uint8-t-slaveAddr-uint8-t-refreshRate" class="headerlink" title="3.1.3. int MLX90640_SetRefreshRate(uint8_t slaveAddr, uint8_t refreshRate);"></a><em>3.1.3. int MLX90640_SetRefreshRate(uint8_t slaveAddr, uint8_t refreshRate);</em></h4><p>该函数在适当的寄存器中写入所需的刷新率值(0x00到0x07)，以便更改具有给定从地址的MLX90640设备的当前刷新率。注意，上电复位后，刷新率将恢复到存储在EEPROM中的刷新率。如果写入成功，返回值为0，如果通信过程中发生NACK，返回值为-1，如果写入值与预期值不相同，返回值为-2。</p>
<ul>
<li><em>uint8_t slaveAddr</em> — MLX90640设备从地址(默认从地址为0x33)</li>
<li><em>uint8_t refreshRate</em> — MLX90640设备当前的刷新率<ul>
<li>0x00 – 0.5Hz</li>
<li>0x01 – 1Hz</li>
<li>0x02 – 2Hz</li>
<li>0x03 – 4Hz</li>
<li>0x04 – 8Hz</li>
<li>0x05 – 16Hz</li>
<li>0x06 – 32Hz</li>
<li>0x07 – 64Hz</li>
</ul>
</li>
</ul>
<p>例如：</p>
<ol>
<li><p>设置从地址0x33的MLX90640设备以16Hz刷新率工作:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_SetRefreshRate  (<span class="number">0x33</span>,<span class="number">0x05</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-1-4-int-MLX90640-GetRefreshRate-uint8-t-slaveAddr"><a href="#3-1-4-int-MLX90640-GetRefreshRate-uint8-t-slaveAddr" class="headerlink" title="3.1.4. int MLX90640_GetRefreshRate(uint8_t slaveAddr);"></a><em>3.1.4. int MLX90640_GetRefreshRate(uint8_t slaveAddr);</em></h4><p>该函数返回具有给定从属地址的MLX90640设备的当前刷新率。请注意，当前的刷新率可能与该设备的EEPROM中设置的刷新率不同。如果结果为-1，则在通信期间发生了NACK，这不是有效的刷新率数据。</p>
<h4 id="3-1-5-int-MLX90640-GetSubPageNumber-uint16-t-frameData"><a href="#3-1-5-int-MLX90640-GetSubPageNumber-uint16-t-frameData" class="headerlink" title="3.1.5. int MLX90640_GetSubPageNumber(uint16_t *frameData);"></a><em>3.1.5. int MLX90640_GetSubPageNumber(uint16_t *frameData);</em></h4><p>这个函数返回MLX90640设备选定帧数据的子页面。</p>
<ul>
<li><em>uint16_t *frameData</em> — 指向已经获取的MLX90640帧数据的指针</li>
</ul>
<p>例如：</p>
<ol>
<li><p>获取MLX90640设备选定帧数据的子页面:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> mlx90640Frame[<span class="number">834</span>];</span><br><span class="line"><span class="type">int</span> Subpage;</span><br><span class="line">Subpage = MLX90640_GetSubPageNumber(mlx90640Frame); <span class="comment">// Subpage = 1，因为这是该帧的实际子页面编号</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-1-6-int-MLX90640-SetInterleavedMode-uint8-t-slaveAddr"><a href="#3-1-6-int-MLX90640-SetInterleavedMode-uint8-t-slaveAddr" class="headerlink" title="3.1.6. int MLX90640_SetInterleavedMode(uint8_t slaveAddr);"></a><em>3.1.6. int MLX90640_SetInterleavedMode(uint8_t slaveAddr);</em></h4><p>该函数将具有给定从地址的MLX90640设备设置为交错模式。注意，上电复位后，模式将恢复到存储在EEPROM中的模式。如果写入成功，返回值为0，如果通信过程中发生NACK，返回值为-1，如果写入值与预期值不相同，返回值为-2。</p>
<h4 id="3-1-7-int-MLX90640-SetChessMode-uint8-t-slaveAddr"><a href="#3-1-7-int-MLX90640-SetChessMode-uint8-t-slaveAddr" class="headerlink" title="3.1.7. int MLX90640_SetChessMode(uint8_t slaveAddr);"></a><em>3.1.7. int MLX90640_SetChessMode(uint8_t slaveAddr);</em></h4><p>该函数将具有给定从属地址的MLX90640设备设置为象棋模式。注意，上电复位后，模式将恢复到存储在EEPROM中的模式。如果写入成功，返回值为0，如果通信过程中发生NACK，返回值为-1，如果写入值与预期值不相同，返回值为-2。</p>
<h4 id="3-1-8-int-MLX90640-GetCurMode-uint8-t-slaveAddr"><a href="#3-1-8-int-MLX90640-GetCurMode-uint8-t-slaveAddr" class="headerlink" title="3.1.8. int MLX90640_GetCurMode(uint8_t slaveAddr);"></a><em>3.1.8. int MLX90640_GetCurMode(uint8_t slaveAddr);</em></h4><p>该函数返回MLX90640设备的工作模式。</p>
<ul>
<li><em>uint8_t slaveAddr</em> — MLX90640设备从地址(默认从地址为0x33)</li>
</ul>
<p>例如：</p>
<ol>
<li><p>获取从地址为0x33的MLX90640设备的工作模式:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> mode;</span><br><span class="line">mode = MLX90640_GetCurMode (<span class="number">0x33</span>); </span><br><span class="line"><span class="comment">//如果设置了交错模式，Mode = 0；如果设置了象棋模式Mode = 1。</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-2-MLX90640的预处理函数"><a href="#3-2-MLX90640的预处理函数" class="headerlink" title="3.2. MLX90640的预处理函数"></a><em>3.2. MLX90640的预处理函数</em></h3><p>这些API函数通常只在上电复位后调用一次，以提取正确计算温度所需的所有参数</p>
<h4 id="3-2-1-int-MLX90640-DumpEE-uint8-t-slaveAddr-uint16-t-eeData"><a href="#3-2-1-int-MLX90640-DumpEE-uint8-t-slaveAddr-uint16-t-eeData" class="headerlink" title="3.2.1. int MLX90640_DumpEE(uint8_t slaveAddr, uint16_t *eeData);"></a><em>3.2.1. int MLX90640_DumpEE(uint8_t slaveAddr, uint16_t *eeData);</em></h4><p>该函数从具有给定从地址的MLX90640设备读取所有必要的<code>EEPROM数据到用户定义的MCU存储器位置</code>（Dump 转储）。为保证正常运行，分配的内存至少应为832个字。如果结果是-1，在通信期间发生了NACK，这不是一个有效的EEPROM数据。</p>
<h4 id="3-2-2-int-MLX90640-ExtractParameters-uint16-t-eeData-paramsMLX90640-mlx90640"><a href="#3-2-2-int-MLX90640-ExtractParameters-uint16-t-eeData-paramsMLX90640-mlx90640" class="headerlink" title="3.2.2. int MLX90640_ExtractParameters(uint16_t *eeData, paramsMLX90640 *mlx90640);"></a><em>3.2.2. int MLX90640_ExtractParameters(uint16_t *eeData, paramsMLX90640 *mlx90640);</em></h4><p>该函数从给定的EEPROM数据数组中提取参数，并将值存储为MLX90640_API.h中定义的类型。提取（Extract）参数（Parameters）后，不再需要EEPROM数据，其存储的内存可以重复使用。如果返回值为-7，则指定位置的EEPROM数据不是有效的MLX90640 EEPROM，并且参数提取被中止。</p>
<ul>
<li><em>uint16_t *eeData</em> — 指向数组的指针，该数组包含要从中提取参数的EEPROM</li>
<li>*paramsMLX90640 *mlx90640 *— 指向类型为paramsMLX90640的变量的指针，在该变量中存储提取的参数。注意，如果在线上有多个MLX90640设备，则可以使用paramsMLX90640类型的数组</li>
</ul>
<p>例如：</p>
<ol>
<li><p>从MLX90640设备的EEPROM中提取参数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> slaveAddress;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> eeMLX90640[<span class="number">832</span>];</span><br><span class="line">paramsMLX90640 mlx90640;</span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_DumpEE (slaveAddress, eeMLX90640); </span><br><span class="line"><span class="comment">//参数从存储在eeMLX90640数组中的EEPROM数据中提取，并存储在类型为paramsMLX90640的mlx90640变量中</span></span><br><span class="line">status =  MLX90640_ExtractParameters(eeMLX90640, &amp;mlx90640); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">        typedef struct</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                int16_t kVdd;</span></span><br><span class="line"><span class="comment">                int16_t vdd25;</span></span><br><span class="line"><span class="comment">                float KvPTAT;</span></span><br><span class="line"><span class="comment">                float KtPTAT;</span></span><br><span class="line"><span class="comment">                uint16_t vPTAT25;</span></span><br><span class="line"><span class="comment">                float alphaPTAT;</span></span><br><span class="line"><span class="comment">                int16_t gainEE;</span></span><br><span class="line"><span class="comment">                float tgc;</span></span><br><span class="line"><span class="comment">                float cpKv;</span></span><br><span class="line"><span class="comment">                float cpKta;</span></span><br><span class="line"><span class="comment">                uint8_t resolutionEE;</span></span><br><span class="line"><span class="comment">                uint8_t calibrationModeEE;</span></span><br><span class="line"><span class="comment">                float KsTa;</span></span><br><span class="line"><span class="comment">                float ksTo[5];</span></span><br><span class="line"><span class="comment">                int16_t ct[5];</span></span><br><span class="line"><span class="comment">                uint16_t alpha[768];    </span></span><br><span class="line"><span class="comment">                uint8_t alphaScale;</span></span><br><span class="line"><span class="comment">                int16_t offset[768];    </span></span><br><span class="line"><span class="comment">                int8_t kta[768];</span></span><br><span class="line"><span class="comment">                uint8_t ktaScale;    </span></span><br><span class="line"><span class="comment">                int8_t kv[768];</span></span><br><span class="line"><span class="comment">                uint8_t kvScale;</span></span><br><span class="line"><span class="comment">                float cpAlpha[2];</span></span><br><span class="line"><span class="comment">                int16_t cpOffset[2];</span></span><br><span class="line"><span class="comment">                float ilChessC[3]; </span></span><br><span class="line"><span class="comment">                uint16_t brokenPixels[5];</span></span><br><span class="line"><span class="comment">                uint16_t outlierPixels[5];  </span></span><br><span class="line"><span class="comment">            &#125; paramsMLX90640;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-3-MLX90640的数据采集函数"><a href="#3-3-MLX90640的数据采集函数" class="headerlink" title="3.3. MLX90640的数据采集函数"></a><em>3.3. MLX90640的数据采集函数</em></h3><p>确保正确数据采集的API函数。</p>
<h4 id="3-3-1-int-MLX90640-SynchFrame-uint8-t-slaveAddr"><a href="#3-3-1-int-MLX90640-SynchFrame-uint8-t-slaveAddr" class="headerlink" title="3.3.1 int MLX90640_SynchFrame(uint8_t slaveAddr);"></a><em>3.3.1 int MLX90640_SynchFrame(uint8_t slaveAddr);</em></h4><p>该函数等待具有给定从属地址的MLX90640设备可用的新数据。该函数的目的是与MLX90640设备同步，以便在数据可用后立即启动数据采集。这将增加在获得新数据之前的可用读取时间。当数据采集和信号处理所需的时间与传感器的刷新时间相当时，该功能特别有用。建议在读取第一帧之前使用帧同步。对于某些系统来说，每隔一段时间重新同步一次可能会有所帮助。这些同步的速率取决于数据处理时间和传感器刷新时间之间的关系。数据处理时间越快，同步速率越慢。如果结果为-1，说明通信过程中发生了NACK，很可能同步失败。请注意，如果在调用函数时已经有新的可用数据，它将被忽略。</p>
<h4 id="3-3-2-int-MLX90640-TriggerMeasurement-uint8-t-slaveAddr"><a href="#3-3-2-int-MLX90640-TriggerMeasurement-uint8-t-slaveAddr" class="headerlink" title="3.3.2. int MLX90640_TriggerMeasurement(uint8_t slaveAddr);"></a><em>3.3.2. int MLX90640_TriggerMeasurement(uint8_t slaveAddr);</em></h4><p>该功能使用I2C标准中描述的global reset命令。如果结果是-2，通信过程中发生了NAK，如果结果是-2，内存写入失败，如果结果是-9，触发不成功，如果结果是0 -触发了测量。触发后，设备总是先测量子页面0，然后再测量子页面1。请注意，此函数将重置支持该命令的同一I2C总线上的所有设备。</p>
<h4 id="3-3-3-int-MLX90640-GetFrameData-uint8-t-slaveAddr-uint16-t-frameData"><a href="#3-3-3-int-MLX90640-GetFrameData-uint8-t-slaveAddr-uint16-t-frameData" class="headerlink" title="3.3.3 int MLX90640_GetFrameData(uint8_t slaveAddr, uint16_t *frameData);"></a><em>3.3.3 int MLX90640_GetFrameData(uint8_t slaveAddr, uint16_t *frameData);</em></h4><p>该函数从具有给定从地址的MLX90640设备读取所有必要的帧数据到用户定义的MCU存储器位置。为保证正常运行，分配的内存至少应为834个字。如果结果为-1，说明在通信过程中发生了NACK，这不是一个有效的帧数据，否则如果结果为-8，说明数据在一定时间内无法获取，帧数据损坏-最有可能的原因是I2C频率太低，否则结果是获取数据的子页面。</p>
<h3 id="3-4-MLX90640的计算相关函数"><a href="#3-4-MLX90640的计算相关函数" class="headerlink" title="3.4. MLX90640的计算相关函数"></a>3.4. MLX90640的计算相关函数</h3><p>为了得到正确计算的温度，应该按一定顺序调用的API函数。</p>
<h4 id="3-4-1-float-MLX90640-GetVdd-uint16-t-frameData-const-paramsMLX90640-params"><a href="#3-4-1-float-MLX90640-GetVdd-uint16-t-frameData-const-paramsMLX90640-params" class="headerlink" title="3.4.1 float MLX90640_GetVdd(uint16_t *frameData, const paramsMLX90640 *params);"></a><em>3.4.1 float MLX90640_GetVdd(uint16_t *frameData, const paramsMLX90640 *params);</em></h4><p>该函数从给定的MLX90640帧数据和提取的参数返回当前Vdd（电压，eg: 3.3V）。结果是一个浮点数。</p>
<h4 id="3-4-2-float-MLX90640-GetTa-uint16-t-frameData-const-paramsMLX90640-params"><a href="#3-4-2-float-MLX90640-GetTa-uint16-t-frameData-const-paramsMLX90640-params" class="headerlink" title="3.4.2 float MLX90640_GetTa(uint16_t *frameData, const paramsMLX90640 *params);"></a><em>3.4.2 float MLX90640_GetTa(uint16_t *frameData, const paramsMLX90640 *params);</em></h4><p>该函数返回在给定MLX90640帧数据和提取的参数中测量的当前Ta（温度，eg：27.18℃）。结果是一个浮点数。</p>
<h4 id="3-4-3-void-MLX90640-CalculateTo-uint16-t-frameData-const-paramsMLX90640-params-float-emissivity-float-tr-float-result"><a href="#3-4-3-void-MLX90640-CalculateTo-uint16-t-frameData-const-paramsMLX90640-params-float-emissivity-float-tr-float-result" class="headerlink" title="3.4.3 void MLX90640_CalculateTo(uint16_t *frameData, const paramsMLX90640 *params, float emissivity, float tr, float *result);"></a><em>3.4.3 void MLX90640_CalculateTo(uint16_t *frameData, const paramsMLX90640 *params, float emissivity, float tr, float *result);</em></h4><p>该函数根据从MLX90640设备读取的<code>帧数据-frame data</code>、为该特定设备提取的<code>参数-parameters</code>和用户定义的<code>发射率-emissivity </code>和<code>反射温度-reflected Temperature</code>，计算帧中所有768个像素的<code>对象温度</code>。为保证正常运行，分配的内存至少应为768个字。</p>
<p>注意:如果不需要绝对温度值，可以使用MLX90640_GetImage()函数代替。在这种情况下，不应该调用MLX90640_ CalculateTo()函数。</p>
<ul>
<li><em>uint16_t *frameData</em> — 指向用户想要存储帧数据的MCU内存位置的指针</li>
<li><em>paramsMLX90640 *params</em>— 指向MCU内存位置的指针，其中存储了MLX90640设备已提取的参数</li>
<li><em>float emissivity</em>— 发射率由用户定义。发射率是被测物体的一种特性</li>
<li><em>float tr</em>— 反射温度由用户定义。如果物体的发射率小于1，则可能有一些温度从物体反射。为了补偿这一点，用户应该输入这个反射温度。可以使用传感器环境温度，但可能需要根据外壳进行一些转换。对于露天的MLX90640，温度变化为-8°C。</li>
<li><em>float *result</em>— 指向用户希望存储对象温度数据的MCU内存位置的指针</li>
</ul>
<p>例如：</p>
<ol>
<li><p>计算一帧内所有像素点的物体温度，物体发射率为0.95，反射温度为23.15℃(由用户测量):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> emissivity = <span class="number">0.95</span>;</span><br><span class="line"><span class="type">float</span> tr;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> slaveAddress;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> eeMLX90640[<span class="number">832</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> mlx90640Frame[<span class="number">834</span>];</span><br><span class="line">paramsMLX90640 mlx90640;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> mlx90640To[<span class="number">768</span>];</span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_DumpEE (slaveAddress, eeMLX90640); </span><br><span class="line">status = MLX90640_ExtractParameters(eeMLX90640, &amp;mlx90640);</span><br><span class="line">status = MLX90640_GetFrameData (<span class="number">0x33</span>,  mlx90640Frame );</span><br><span class="line">tr = <span class="number">23.15</span>;</span><br><span class="line"><span class="comment">//一个帧中所有768个像素的对象温度存储在mlx90640To数组中</span></span><br><span class="line">MLX90640_CalculateTo(mlx90640Frame, &amp;mlx90640, emissivity, tr, mlx90640To);</span><br></pre></td></tr></table></figure>
</li>
<li><p>计算一帧内所有像素点的物体温度，物体发射率为0.95，反射温度为传感器环境温度:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TA_SHIFT 8 <span class="comment">// MLX90640设备在露天的默认位移</span></span></span><br><span class="line"><span class="type">float</span> emissivity = <span class="number">0.95</span>;</span><br><span class="line"><span class="type">float</span> tr;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> slaveAddress;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> eeMLX90640[<span class="number">832</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> mlx90640Frame[<span class="number">834</span>];</span><br><span class="line">paramsMLX90640 mlx90640;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> mlx90640To[<span class="number">768</span>];</span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_DumpEE (slaveAddress, eeMLX90640); </span><br><span class="line">status = MLX90640_ExtractParameters(eeMLX90640, &amp;mlx90640);</span><br><span class="line">status = MLX90640_GetFrameData (<span class="number">0x33</span>,  mlx90640Frame );</span><br><span class="line">tr = MLX90640_GetTa(mlx90640Frame, &amp;mlx90640) – TA_SHIFT;<span class="comment">//基于传感器环境温度的反射温度</span></span><br><span class="line"><span class="comment">//一个帧中所有768个像素的对象温度存储在mlx90640To数组中</span></span><br><span class="line">MLX90640_CalculateTo(mlx90640Frame, &amp;mlx90640, emissivity, tr, mlx90640To);</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-4-4-void-MLX90640-GetImage-uint16-t-frameData-const-paramsMLX90640-params-float-result"><a href="#3-4-4-void-MLX90640-GetImage-uint16-t-frameData-const-paramsMLX90640-params-float-result" class="headerlink" title="3.4.4 void MLX90640_GetImage(uint16_t *frameData, const paramsMLX90640 *params, float *result);"></a><em>3.4.4 void MLX90640_GetImage(uint16_t *frameData, const paramsMLX90640 *params, float *result);</em></h4><p>该函数根据从MLX90640设备读取的帧数据和为该特定设备提取的参数计算帧中所有768个像素的值。为保证正常运行，分配的内存至少应为768个字。该值越小，像素视场中的温度越低。注意，这些都是带符号的值。</p>
<p>注意:如果需要绝对温度值，则应该使用MLX90640_CalculateTo()。在这种情况下，不应该调用函数MLX90640_GetImage()。</p>
<ul>
<li><em>uint16_t *frameData</em> — 指向用户希望存储帧数据的MCU内存位置的指针</li>
<li>*paramsMLX90640 *params *— 指向MCU内存位置的指针，其中存储了MLX90640设备已提取的参数</li>
<li>*float *result *— 指向用户希望存储对象温度数据的MCU内存位置的指针</li>
</ul>
<p>例如：</p>
<ol>
<li><p>获取一个帧的图像:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> slaveAddress;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> eeMLX90640[<span class="number">832</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> mlx90640Frame[<span class="number">834</span>];</span><br><span class="line">paramsMLX90640 mlx90640;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> mlx90640Image[<span class="number">768</span>];</span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_DumpEE (slaveAddress, eeMLX90640); </span><br><span class="line">status = MLX90640_ExtractParameters(eeMLX90640, &amp;mlx90640);</span><br><span class="line">status = MLX90640_GetFrameData (<span class="number">0x33</span>,  mlx90640Frame );</span><br><span class="line">MLX90640_GetImage(mlx90640Frame, &amp;mlx90640, mlx90640Image);</span><br><span class="line"><span class="comment">//从帧数据中提取图像并存储在mlx90640Image数组中</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-5-MLX90640支持图像处理的函数"><a href="#3-5-MLX90640支持图像处理的函数" class="headerlink" title="3.5. MLX90640支持图像处理的函数"></a><em>3.5. MLX90640支持图像处理的函数</em></h3><p>可用于图像处理的API函数。</p>
<h4 id="3-5-1-void-MLX90640-BadPixelsCorrection-uint16-t-pixels-float-to-int-mode-paramsMLX90640-params"><a href="#3-5-1-void-MLX90640-BadPixelsCorrection-uint16-t-pixels-float-to-int-mode-paramsMLX90640-params" class="headerlink" title="3.5.1 void MLX90640_BadPixelsCorrection(uint16_t *pixels, float *to, int mode, paramsMLX90640 *params);"></a><em>3.5.1 void MLX90640_BadPixelsCorrection(uint16_t *pixels, float *to, int mode, paramsMLX90640 *params);</em></h4><p>这个函数修正了坏像素和&#x2F;或异常像素的值。像素数组中所有像素索引的值（直到读取到值0xFFFF）将使用不同的过滤方法进行修正。在paramsMLX90640数组brokenPixels和outlierPixels中已经报告了标记为坏像素或异常像素的像素。请注意，可以通过创建一个包含那些像素索引的自定义列表来选择要修正的像素。列表应该以0xFFFF结尾。</p>
<ul>
<li><p><em>uint16_t *pixels</em> — 指向包含待校正像素的数组的指针。</p>
<p><strong>注意：数组应该包含像素的索引(0到767)，0xFFFF应该用作终止值</strong></p>
</li>
<li><p><em>float *to</em> — 指向对象温度值数组的指针。通过覆盖对应像素指数的当前温度值来校正像素值</p>
</li>
<li><p><em>int mode</em> — MLX90640设备当前的工作模式</p>
<ul>
<li>0 — 交错模式</li>
<li>1 — 棋盘模式</li>
</ul>
</li>
<li><p><em>paramsMLX90640 *params</em> — 指向MCU内存位置的指针，其中存储了MLX90640设备已提取的参数</p>
</li>
</ul>
<p>例如：</p>
<ol>
<li><p>在一帧中修正对象温度为所有像素被标记为坏的或异常的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> emissivity = <span class="number">0.95</span>;</span><br><span class="line"><span class="type">float</span> tr;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> slaveAddress;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> eeMLX90640[<span class="number">832</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> mlx90640Frame[<span class="number">834</span>];</span><br><span class="line">paramsMLX90640 mlx90640;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> mlx90640To[<span class="number">768</span>];</span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_DumpEE (slaveAddress, eeMLX90640); </span><br><span class="line">status = MLX90640_ExtractParameters(eeMLX90640, &amp;mlx90640);</span><br><span class="line">mode = MLX90640_GetCurMode(slaveAddress);</span><br><span class="line">status = MLX90640_GetFrameData (<span class="number">0x33</span>,  mlx90640Frame );</span><br><span class="line">tr = <span class="number">23.15</span>;</span><br><span class="line">MLX90640_CalculateTo(mlx90640Frame, &amp;mlx90640, emissivity, tr, mlx90640To);</span><br><span class="line">MLX90640_BadPixelsCorrection((&amp;mlx90640)-&gt;brokenPixels, mlx90640To, mode, &amp;mlx90640);</span><br><span class="line">MLX90640_BadPixelsCorrection((&amp;mlx90640)-&gt;outlierPixels, mlx90640To, mode, &amp;mlx90640);</span><br><span class="line"><span class="comment">//修正值在mlx90640To数组中</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用自定义列表修正所有所需像素的对象温度:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> emissivity = <span class="number">0.95</span>;</span><br><span class="line"><span class="type">float</span> tr;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> slaveAddress;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> eeMLX90640[<span class="number">832</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> mlx90640Frame[<span class="number">834</span>];</span><br><span class="line">paramsMLX90640 mlx90640;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> mlx90640To[<span class="number">768</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> badPixels[<span class="number">5</span>] = &#123;<span class="number">0</span>, <span class="number">35</span>, <span class="number">150</span>, <span class="number">500</span>, <span class="number">0xFFFF</span>&#125;;  <span class="comment">//create a custom list of pixels to correct</span></span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = MLX90640_DumpEE (slaveAddress, eeMLX90640); </span><br><span class="line">status = MLX90640_ExtractParameters(eeMLX90640, &amp;mlx90640);</span><br><span class="line">mode = MLX90640_GetCurMode(slaveAddress);</span><br><span class="line">status = MLX90640_GetFrameData (<span class="number">0x33</span>,  mlx90640Frame );</span><br><span class="line">tr = <span class="number">23.15</span>;</span><br><span class="line">MLX90640_CalculateTo(mlx90640Frame, &amp;mlx90640, emissivity, tr, mlx90640To);</span><br><span class="line">MLX90640_BadPixelsCorrection(badPixels, mlx90640To, mode, &amp;mlx90640);</span><br><span class="line"><span class="comment">//修正值在mlx90640To数组中</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-历史版本表"><a href="#4-历史版本表" class="headerlink" title="4. 历史版本表"></a>4. 历史版本表</h2><ul>
<li>我不写了</li>
</ul>
<h2 id="5-程序源码"><a href="#5-程序源码" class="headerlink" title="5. 程序源码"></a>5. 程序源码</h2><blockquote>
<p>  原文中没有本章节</p>
</blockquote>
<h3 id="MLX90640-I2C-Driver-h"><a href="#MLX90640-I2C-Driver-h" class="headerlink" title="MLX90640_I2C_Driver.h"></a><code>MLX90640_I2C_Driver.h</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @copyright (C) 2017 Melexis N.V.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _MLX90640_I2C_Driver_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _MLX90640_I2C_Driver_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MLX90640_API.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">MLX90640_I2CInit</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">    <span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">MLX90640_I2CGeneralReset</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">    <span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">MLX90640_I2CRead</span><span class="params">(<span class="type">uint8_t</span> slaveAddr,<span class="type">uint16_t</span> startAddress, <span class="type">uint16_t</span> nMemAddressRead, <span class="type">uint16_t</span> *data)</span>;</span><br><span class="line">    <span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">MLX90640_I2CWrite</span><span class="params">(<span class="type">uint8_t</span> slaveAddr,<span class="type">uint16_t</span> writeAddress, <span class="type">uint16_t</span> data)</span>;</span><br><span class="line">    <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">MLX90640_I2CFreqSet</span><span class="params">(<span class="type">int</span> freq)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="MLX90640-API-h"><a href="#MLX90640-API-h" class="headerlink" title="MLX90640_API.h"></a><code>MLX90640_API.h</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @copyright (C) 2017 Melexis N.V.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _MLX90640_API_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _MLX90640_API_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NO_ERROR 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_I2C_NACK_ERROR 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_I2C_WRITE_ERROR 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_BROKEN_PIXELS_NUM_ERROR 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_OUTLIER_PIXELS_NUM_ERROR 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_BAD_PIXELS_NUM_ERROR 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_ADJACENT_BAD_PIXELS_ERROR 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_EEPROM_DATA_ERROR 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_FRAME_DATA_ERROR 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_MEAS_TRIGGER_ERROR 9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIT_MASK(x) (1UL &lt;&lt; (x))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REG_MASK(sbit,nbits) ~((~(~0UL &lt;&lt; (nbits))) &lt;&lt; (sbit))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_EEPROM_START_ADDRESS 0x2400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_EEPROM_DUMP_NUM 832</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_PIXEL_DATA_START_ADDRESS 0x0400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_PIXEL_NUM 768</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_LINE_NUM 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_COLUMN_NUM 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_LINE_SIZE 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_COLUMN_SIZE 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_AUX_DATA_START_ADDRESS 0x0700</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_AUX_NUM 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_STATUS_REG 0x8000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_INIT_STATUS_VALUE 0x0030</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_STAT_FRAME_MASK BIT_MASK(0) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_GET_FRAME(reg_value) (reg_value &amp; MLX90640_STAT_FRAME_MASK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_STAT_DATA_READY_MASK BIT_MASK(3) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_GET_DATA_READY(reg_value) (reg_value &amp; MLX90640_STAT_DATA_READY_MASK)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_REG 0x800D</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_TRIG_READY_MASK BIT_MASK(15) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_REFRESH_SHIFT 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_REFRESH_MASK REG_MASK(MLX90640_CTRL_REFRESH_SHIFT,3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_RESOLUTION_SHIFT 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_RESOLUTION_MASK REG_MASK(MLX90640_CTRL_RESOLUTION_SHIFT,2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_MEAS_MODE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_CTRL_MEAS_MODE_MASK BIT_MASK(12)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_MS_BYTE_SHIFT 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_MS_BYTE_MASK 0xFF00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_LS_BYTE_MASK 0x00FF</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_MS_BYTE(reg16) ((reg16 &amp; MLX90640_MS_BYTE_MASK) &gt;&gt; MLX90640_MS_BYTE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_LS_BYTE(reg16) (reg16 &amp; MLX90640_LS_BYTE_MASK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_MSBITS_6_MASK 0xFC00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_LSBITS_10_MASK 0x03FF</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE1_MASK 0x000F</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE2_MASK 0x00F0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE3_MASK 0x0F00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE4_MASK 0xF000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE1(reg16) ((reg16 &amp; MLX90640_NIBBLE1_MASK))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE2(reg16) ((reg16 &amp; MLX90640_NIBBLE2_MASK) &gt;&gt; 4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE3(reg16) ((reg16 &amp; MLX90640_NIBBLE3_MASK) &gt;&gt; 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLX90640_NIBBLE4(reg16) ((reg16 &amp; MLX90640_NIBBLE4_MASK) &gt;&gt; 12)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POW2(x) pow(2, (double)x) </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCALEALPHA 0.000001</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="type">int16_t</span> kVdd;</span><br><span class="line">        <span class="type">int16_t</span> vdd25;</span><br><span class="line">        <span class="type">float</span> KvPTAT;</span><br><span class="line">        <span class="type">float</span> KtPTAT;</span><br><span class="line">        <span class="type">uint16_t</span> vPTAT25;</span><br><span class="line">        <span class="type">float</span> alphaPTAT;</span><br><span class="line">        <span class="type">int16_t</span> gainEE;</span><br><span class="line">        <span class="type">float</span> tgc;</span><br><span class="line">        <span class="type">float</span> cpKv;</span><br><span class="line">        <span class="type">float</span> cpKta;</span><br><span class="line">        <span class="type">uint8_t</span> resolutionEE;</span><br><span class="line">        <span class="type">uint8_t</span> calibrationModeEE;</span><br><span class="line">        <span class="type">float</span> KsTa;</span><br><span class="line">        <span class="type">float</span> ksTo[<span class="number">5</span>];</span><br><span class="line">        <span class="type">int16_t</span> ct[<span class="number">5</span>];</span><br><span class="line">        <span class="type">uint16_t</span> alpha[<span class="number">768</span>];    </span><br><span class="line">        <span class="type">uint8_t</span> alphaScale;</span><br><span class="line">        <span class="type">int16_t</span> offset[<span class="number">768</span>];    </span><br><span class="line">        <span class="type">int8_t</span> kta[<span class="number">768</span>];</span><br><span class="line">        <span class="type">uint8_t</span> ktaScale;    </span><br><span class="line">        <span class="type">int8_t</span> kv[<span class="number">768</span>];</span><br><span class="line">        <span class="type">uint8_t</span> kvScale;</span><br><span class="line">        <span class="type">float</span> cpAlpha[<span class="number">2</span>];</span><br><span class="line">        <span class="type">int16_t</span> cpOffset[<span class="number">2</span>];</span><br><span class="line">        <span class="type">float</span> ilChessC[<span class="number">3</span>]; </span><br><span class="line">        <span class="type">uint16_t</span> brokenPixels[<span class="number">5</span>];</span><br><span class="line">        <span class="type">uint16_t</span> outlierPixels[<span class="number">5</span>];  </span><br><span class="line">    &#125; paramsMLX90640;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_DumpEE</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint16_t</span> *eeData)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_SynchFrame</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_TriggerMeasurement</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_GetFrameData</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint16_t</span> *frameData)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_ExtractParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line">    <span class="type">float</span> <span class="title function_">MLX90640_GetVdd</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params)</span>;</span><br><span class="line">    <span class="type">float</span> <span class="title function_">MLX90640_GetTa</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">MLX90640_GetImage</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params, <span class="type">float</span> *result)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">MLX90640_CalculateTo</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params, <span class="type">float</span> emissivity, <span class="type">float</span> tr, <span class="type">float</span> *result)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_SetResolution</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint8_t</span> resolution)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_GetCurResolution</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_SetRefreshRate</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint8_t</span> refreshRate)</span>;   </span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_GetRefreshRate</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span>;  </span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_GetSubPageNumber</span><span class="params">(<span class="type">uint16_t</span> *frameData)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_GetCurMode</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span>; </span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_SetInterleavedMode</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">MLX90640_SetChessMode</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">MLX90640_BadPixelsCorrection</span><span class="params">(<span class="type">uint16_t</span> *pixels, <span class="type">float</span> *to, <span class="type">int</span> mode, paramsMLX90640 *params)</span>;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="MLX90640-API-c"><a href="#MLX90640-API-c" class="headerlink" title="MLX90640_API.c"></a><code>MLX90640_API.c</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @copyright (C) 2017 Melexis N.V.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;MLX90640_I2C_Driver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;MLX90640_API.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractVDDParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractPTATParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractGainParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractTgcParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractResolutionParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKsTaParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKsToParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractAlphaParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractOffsetParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKtaPixelParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKvPixelParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractCPParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractCILCParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ExtractDeviatingPixels</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">CheckAdjacentPixels</span><span class="params">(<span class="type">uint16_t</span> pix1, <span class="type">uint16_t</span> pix2)</span>;  </span><br><span class="line"><span class="type">static</span> <span class="type">float</span> <span class="title function_">GetMedian</span><span class="params">(<span class="type">float</span> *values, <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">IsPixelBad</span><span class="params">(<span class="type">uint16_t</span> pixel,paramsMLX90640 *params)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ValidateFrameData</span><span class="params">(<span class="type">uint16_t</span> *frameData)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ValidateAuxData</span><span class="params">(<span class="type">uint16_t</span> *auxData)</span>;</span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_DumpEE</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint16_t</span> *eeData)</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">return</span> MLX90640_I2CRead(slaveAddr, MLX90640_EEPROM_START_ADDRESS, MLX90640_EEPROM_DUMP_NUM, eeData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_SynchFrame</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> dataReady = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint16_t</span> statusRegister;</span><br><span class="line">    <span class="type">int</span> error = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CWrite(slaveAddr, MLX90640_STATUS_REG, MLX90640_INIT_STATUS_VALUE);</span><br><span class="line">    <span class="keyword">if</span>(error == -MLX90640_I2C_NACK_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(dataReady == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        error = MLX90640_I2CRead(slaveAddr, MLX90640_STATUS_REG, <span class="number">1</span>, &amp;statusRegister);</span><br><span class="line">        <span class="keyword">if</span>(error != MLX90640_NO_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> error;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="comment">//dataReady = statusRegister &amp; 0x0008;</span></span><br><span class="line">        dataReady = MLX90640_GET_DATA_READY(statusRegister); </span><br><span class="line">    &#125;     </span><br><span class="line">    </span><br><span class="line">   <span class="keyword">return</span> MLX90640_NO_ERROR;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_TriggerMeasurement</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> error = <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint16_t</span> ctrlReg;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;ctrlReg);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( error != MLX90640_NO_ERROR) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;    </span><br><span class="line">                                                </span><br><span class="line">    ctrlReg |= MLX90640_CTRL_TRIG_READY_MASK;</span><br><span class="line">    error = MLX90640_I2CWrite(slaveAddr, MLX90640_CTRL_REG, ctrlReg);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CGeneralReset();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;ctrlReg);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((ctrlReg &amp; MLX90640_CTRL_TRIG_READY_MASK) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -MLX90640_MEAS_TRIGGER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> MLX90640_NO_ERROR;    </span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_GetFrameData</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint16_t</span> *frameData)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> dataReady = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">uint16_t</span> statusRegister;</span><br><span class="line">    <span class="type">int</span> error = <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint16_t</span> data[<span class="number">64</span>];</span><br><span class="line">    <span class="type">uint8_t</span> cnt = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(dataReady == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        error = MLX90640_I2CRead(slaveAddr, MLX90640_STATUS_REG, <span class="number">1</span>, &amp;statusRegister);</span><br><span class="line">        <span class="keyword">if</span>(error != MLX90640_NO_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> error;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="comment">//dataReady = statusRegister &amp; 0x0008;</span></span><br><span class="line">        dataReady = MLX90640_GET_DATA_READY(statusRegister); </span><br><span class="line">    &#125;      </span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CWrite(slaveAddr, MLX90640_STATUS_REG, MLX90640_INIT_STATUS_VALUE);</span><br><span class="line">    <span class="keyword">if</span>(error == -MLX90640_I2C_NACK_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">                     </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_PIXEL_DATA_START_ADDRESS, MLX90640_PIXEL_NUM, frameData); </span><br><span class="line">    <span class="keyword">if</span>(error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;                       </span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_AUX_DATA_START_ADDRESS, MLX90640_AUX_NUM, data); </span><br><span class="line">    <span class="keyword">if</span>(error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;     </span><br><span class="line">        </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    frameData[<span class="number">832</span>] = controlRegister1;</span><br><span class="line">    <span class="comment">//frameData[833] = statusRegister &amp; 0x0001;</span></span><br><span class="line">    frameData[<span class="number">833</span>] = MLX90640_GET_FRAME(statusRegister);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    error = ValidateAuxData(data);</span><br><span class="line">    <span class="keyword">if</span>(error == MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(cnt=<span class="number">0</span>; cnt&lt;MLX90640_AUX_NUM; cnt++)</span><br><span class="line">        &#123;</span><br><span class="line">            frameData[cnt+MLX90640_PIXEL_NUM] = data[cnt];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;        </span><br><span class="line">    </span><br><span class="line">    error = ValidateFrameData(frameData);</span><br><span class="line">    <span class="keyword">if</span> (error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> frameData[<span class="number">833</span>];    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ValidateFrameData</span><span class="params">(<span class="type">uint16_t</span> *frameData)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> line = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;MLX90640_PIXEL_NUM; i+=MLX90640_LINE_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((frameData[i] == <span class="number">0x7FFF</span>) &amp;&amp; (line%<span class="number">2</span> == frameData[<span class="number">833</span>])) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;</span><br><span class="line">        line = line + <span class="number">1</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> MLX90640_NO_ERROR;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ValidateAuxData</span><span class="params">(<span class="type">uint16_t</span> *auxData)</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(auxData[<span class="number">0</span>] == <span class="number">0x7FFF</span>) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">8</span>; i&lt;<span class="number">19</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(auxData[i] == <span class="number">0x7FFF</span>) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">20</span>; i&lt;<span class="number">23</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(auxData[i] == <span class="number">0x7FFF</span>) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">24</span>; i&lt;<span class="number">33</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(auxData[i] == <span class="number">0x7FFF</span>) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">40</span>; i&lt;<span class="number">51</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(auxData[i] == <span class="number">0x7FFF</span>) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">52</span>; i&lt;<span class="number">55</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(auxData[i] == <span class="number">0x7FFF</span>) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">56</span>; i&lt;<span class="number">64</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(auxData[i] == <span class="number">0x7FFF</span>) <span class="keyword">return</span> -MLX90640_FRAME_DATA_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> MLX90640_NO_ERROR;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_ExtractParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> error = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ExtractVDDParameters(eeData, mlx90640);</span><br><span class="line">    ExtractPTATParameters(eeData, mlx90640);</span><br><span class="line">    ExtractGainParameters(eeData, mlx90640);</span><br><span class="line">    ExtractTgcParameters(eeData, mlx90640);</span><br><span class="line">    ExtractResolutionParameters(eeData, mlx90640);</span><br><span class="line">    ExtractKsTaParameters(eeData, mlx90640);</span><br><span class="line">    ExtractKsToParameters(eeData, mlx90640);</span><br><span class="line">    ExtractCPParameters(eeData, mlx90640);</span><br><span class="line">    ExtractAlphaParameters(eeData, mlx90640);</span><br><span class="line">    ExtractOffsetParameters(eeData, mlx90640);</span><br><span class="line">    ExtractKtaPixelParameters(eeData, mlx90640);</span><br><span class="line">    ExtractKvPixelParameters(eeData, mlx90640);</span><br><span class="line">    ExtractCILCParameters(eeData, mlx90640);</span><br><span class="line">    error = ExtractDeviatingPixels(eeData, mlx90640);  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_SetResolution</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint8_t</span> resolution)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">uint16_t</span> value;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//value = (resolution &amp; 0x03) &lt;&lt; 10;</span></span><br><span class="line">    value = ((<span class="type">uint16_t</span>)resolution &lt;&lt; MLX90640_CTRL_RESOLUTION_SHIFT);</span><br><span class="line">    value &amp;= ~MLX90640_CTRL_RESOLUTION_MASK;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(error == MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        value = (controlRegister1 &amp; MLX90640_CTRL_RESOLUTION_MASK) | value;</span><br><span class="line">        error = MLX90640_I2CWrite(slaveAddr, MLX90640_CTRL_REG, value);        </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_GetCurResolution</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">int</span> resolutionRAM;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    <span class="keyword">if</span>(error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;    </span><br><span class="line">    resolutionRAM = (controlRegister1 &amp; ~MLX90640_CTRL_RESOLUTION_MASK) &gt;&gt; MLX90640_CTRL_RESOLUTION_SHIFT;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resolutionRAM; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_SetRefreshRate</span><span class="params">(<span class="type">uint8_t</span> slaveAddr, <span class="type">uint8_t</span> refreshRate)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">uint16_t</span> value;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//value = (refreshRate &amp; 0x07)&lt;&lt;7;</span></span><br><span class="line">    value = ((<span class="type">uint16_t</span>)refreshRate &lt;&lt; MLX90640_CTRL_REFRESH_SHIFT);</span><br><span class="line">    value &amp;= ~MLX90640_CTRL_REFRESH_MASK;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    <span class="keyword">if</span>(error == MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        value = (controlRegister1 &amp; MLX90640_CTRL_REFRESH_MASK) | value;</span><br><span class="line">        error = MLX90640_I2CWrite(slaveAddr, MLX90640_CTRL_REG, value);</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_GetRefreshRate</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">int</span> refreshRate;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    <span class="keyword">if</span>(error != MLX90640_NO_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;    </span><br><span class="line">    refreshRate = (controlRegister1 &amp; ~MLX90640_CTRL_REFRESH_MASK) &gt;&gt; MLX90640_CTRL_REFRESH_SHIFT;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> refreshRate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_SetInterleavedMode</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">uint16_t</span> value;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(error == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        value = (controlRegister1 &amp; ~MLX90640_CTRL_MEAS_MODE_MASK);</span><br><span class="line">        error = MLX90640_I2CWrite(slaveAddr, MLX90640_CTRL_REG, value);        </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_SetChessMode</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">uint16_t</span> value;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">        </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(error == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        value = (controlRegister1 | MLX90640_CTRL_MEAS_MODE_MASK);</span><br><span class="line">        error = MLX90640_I2CWrite(slaveAddr, MLX90640_CTRL_REG, value);        </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_GetCurMode</span><span class="params">(<span class="type">uint8_t</span> slaveAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> controlRegister1;</span><br><span class="line">    <span class="type">int</span> modeRAM;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    </span><br><span class="line">    error = MLX90640_I2CRead(slaveAddr, MLX90640_CTRL_REG, <span class="number">1</span>, &amp;controlRegister1);</span><br><span class="line">    <span class="keyword">if</span>(error != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;    </span><br><span class="line">    modeRAM = (controlRegister1 &amp; MLX90640_CTRL_MEAS_MODE_MASK) &gt;&gt; MLX90640_CTRL_MEAS_MODE_SHIFT;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> modeRAM; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">MLX90640_CalculateTo</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params, <span class="type">float</span> emissivity, <span class="type">float</span> tr, <span class="type">float</span> *result)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> vdd;</span><br><span class="line">    <span class="type">float</span> ta;</span><br><span class="line">    <span class="type">float</span> ta4;</span><br><span class="line">    <span class="type">float</span> tr4;</span><br><span class="line">    <span class="type">float</span> taTr;</span><br><span class="line">    <span class="type">float</span> gain;</span><br><span class="line">    <span class="type">float</span> irDataCP[<span class="number">2</span>];</span><br><span class="line">    <span class="type">float</span> irData;</span><br><span class="line">    <span class="type">float</span> alphaCompensated;</span><br><span class="line">    <span class="type">uint8_t</span> mode;</span><br><span class="line">    <span class="type">int8_t</span> ilPattern;</span><br><span class="line">    <span class="type">int8_t</span> chessPattern;</span><br><span class="line">    <span class="type">int8_t</span> pattern;</span><br><span class="line">    <span class="type">int8_t</span> conversionPattern;</span><br><span class="line">    <span class="type">float</span> Sx;</span><br><span class="line">    <span class="type">float</span> To;</span><br><span class="line">    <span class="type">float</span> alphaCorrR[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int8_t</span> range;</span><br><span class="line">    <span class="type">uint16_t</span> subPage;</span><br><span class="line">    <span class="type">float</span> ktaScale;</span><br><span class="line">    <span class="type">float</span> kvScale;</span><br><span class="line">    <span class="type">float</span> alphaScale;</span><br><span class="line">    <span class="type">float</span> kta;</span><br><span class="line">    <span class="type">float</span> kv;</span><br><span class="line">    </span><br><span class="line">    subPage = frameData[<span class="number">833</span>];</span><br><span class="line">    vdd = MLX90640_GetVdd(frameData, params);</span><br><span class="line">    ta = MLX90640_GetTa(frameData, params);</span><br><span class="line">    </span><br><span class="line">    ta4 = (ta + <span class="number">273.15</span>);</span><br><span class="line">    ta4 = ta4 * ta4;</span><br><span class="line">    ta4 = ta4 * ta4;</span><br><span class="line">    tr4 = (tr + <span class="number">273.15</span>);</span><br><span class="line">    tr4 = tr4 * tr4;</span><br><span class="line">    tr4 = tr4 * tr4;</span><br><span class="line">    taTr = tr4 - (tr4-ta4)/emissivity;</span><br><span class="line">    </span><br><span class="line">    ktaScale = POW2(params-&gt;ktaScale);</span><br><span class="line">    kvScale = POW2(params-&gt;kvScale);</span><br><span class="line">    alphaScale = POW2(params-&gt;alphaScale);</span><br><span class="line">    </span><br><span class="line">    alphaCorrR[<span class="number">0</span>] = <span class="number">1</span> / (<span class="number">1</span> + params-&gt;ksTo[<span class="number">0</span>] * <span class="number">40</span>);</span><br><span class="line">    alphaCorrR[<span class="number">1</span>] = <span class="number">1</span> ;</span><br><span class="line">    alphaCorrR[<span class="number">2</span>] = (<span class="number">1</span> + params-&gt;ksTo[<span class="number">1</span>] * params-&gt;ct[<span class="number">2</span>]);</span><br><span class="line">    alphaCorrR[<span class="number">3</span>] = alphaCorrR[<span class="number">2</span>] * (<span class="number">1</span> + params-&gt;ksTo[<span class="number">2</span>] * (params-&gt;ct[<span class="number">3</span>] - params-&gt;ct[<span class="number">2</span>]));</span><br><span class="line">    </span><br><span class="line"><span class="comment">//------------------------- Gain calculation -----------------------------------    </span></span><br><span class="line">    </span><br><span class="line">    gain = (<span class="type">float</span>)params-&gt;gainEE / (<span class="type">int16_t</span>)frameData[<span class="number">778</span>]; </span><br><span class="line">  </span><br><span class="line"><span class="comment">//------------------------- To calculation -------------------------------------    </span></span><br><span class="line">    mode = (frameData[<span class="number">832</span>] &amp; MLX90640_CTRL_MEAS_MODE_MASK) &gt;&gt; <span class="number">5</span>;</span><br><span class="line">    </span><br><span class="line">    irDataCP[<span class="number">0</span>] = (<span class="type">int16_t</span>)frameData[<span class="number">776</span>] * gain;</span><br><span class="line">    irDataCP[<span class="number">1</span>] = (<span class="type">int16_t</span>)frameData[<span class="number">808</span>] * gain;</span><br><span class="line">    </span><br><span class="line">    irDataCP[<span class="number">0</span>] = irDataCP[<span class="number">0</span>] - params-&gt;cpOffset[<span class="number">0</span>] * (<span class="number">1</span> + params-&gt;cpKta * (ta - <span class="number">25</span>)) * (<span class="number">1</span> + params-&gt;cpKv * (vdd - <span class="number">3.3</span>));</span><br><span class="line">    <span class="keyword">if</span>( mode ==  params-&gt;calibrationModeEE)</span><br><span class="line">    &#123;</span><br><span class="line">        irDataCP[<span class="number">1</span>] = irDataCP[<span class="number">1</span>] - params-&gt;cpOffset[<span class="number">1</span>] * (<span class="number">1</span> + params-&gt;cpKta * (ta - <span class="number">25</span>)) * (<span class="number">1</span> + params-&gt;cpKv * (vdd - <span class="number">3.3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      irDataCP[<span class="number">1</span>] = irDataCP[<span class="number">1</span>] - (params-&gt;cpOffset[<span class="number">1</span>] + params-&gt;ilChessC[<span class="number">0</span>]) * (<span class="number">1</span> + params-&gt;cpKta * (ta - <span class="number">25</span>)) * (<span class="number">1</span> + params-&gt;cpKv * (vdd - <span class="number">3.3</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> pixelNumber = <span class="number">0</span>; pixelNumber &lt; <span class="number">768</span>; pixelNumber++)</span><br><span class="line">    &#123;</span><br><span class="line">        ilPattern = pixelNumber / <span class="number">32</span> - (pixelNumber / <span class="number">64</span>) * <span class="number">2</span>; </span><br><span class="line">        chessPattern = ilPattern ^ (pixelNumber - (pixelNumber/<span class="number">2</span>)*<span class="number">2</span>); </span><br><span class="line">        conversionPattern = ((pixelNumber + <span class="number">2</span>) / <span class="number">4</span> - (pixelNumber + <span class="number">3</span>) / <span class="number">4</span> + (pixelNumber + <span class="number">1</span>) / <span class="number">4</span> - pixelNumber / <span class="number">4</span>) * (<span class="number">1</span> - <span class="number">2</span> * ilPattern);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(mode == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          pattern = ilPattern; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">          pattern = chessPattern; </span><br><span class="line">        &#125;               </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(pattern == frameData[<span class="number">833</span>])</span><br><span class="line">        &#123;    </span><br><span class="line">            irData = (<span class="type">int16_t</span>)frameData[pixelNumber] * gain;</span><br><span class="line">            </span><br><span class="line">            kta = params-&gt;kta[pixelNumber]/ktaScale;</span><br><span class="line">            kv = params-&gt;kv[pixelNumber]/kvScale;</span><br><span class="line">            irData = irData - params-&gt;offset[pixelNumber]*(<span class="number">1</span> + kta*(ta - <span class="number">25</span>))*(<span class="number">1</span> + kv*(vdd - <span class="number">3.3</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(mode !=  params-&gt;calibrationModeEE)</span><br><span class="line">            &#123;</span><br><span class="line">              irData = irData + params-&gt;ilChessC[<span class="number">2</span>] * (<span class="number">2</span> * ilPattern - <span class="number">1</span>) - params-&gt;ilChessC[<span class="number">1</span>] * conversionPattern; </span><br><span class="line">            &#125;                       </span><br><span class="line">    </span><br><span class="line">            irData = irData - params-&gt;tgc * irDataCP[subPage];</span><br><span class="line">            irData = irData / emissivity;</span><br><span class="line">            </span><br><span class="line">            alphaCompensated = SCALEALPHA*alphaScale/params-&gt;alpha[pixelNumber];</span><br><span class="line">            alphaCompensated = alphaCompensated*(<span class="number">1</span> + params-&gt;KsTa * (ta - <span class="number">25</span>));</span><br><span class="line">                        </span><br><span class="line">            Sx = alphaCompensated * alphaCompensated * alphaCompensated * (irData + alphaCompensated * taTr);</span><br><span class="line">            Sx = <span class="built_in">sqrt</span>(<span class="built_in">sqrt</span>(Sx)) * params-&gt;ksTo[<span class="number">1</span>];            </span><br><span class="line">            </span><br><span class="line">            To = <span class="built_in">sqrt</span>(<span class="built_in">sqrt</span>(irData/(alphaCompensated * (<span class="number">1</span> - params-&gt;ksTo[<span class="number">1</span>] * <span class="number">273.15</span>) + Sx) + taTr)) - <span class="number">273.15</span>;                     </span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">if</span>(To &lt; params-&gt;ct[<span class="number">1</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                range = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(To &lt; params-&gt;ct[<span class="number">2</span>])   </span><br><span class="line">            &#123;</span><br><span class="line">                range = <span class="number">1</span>;            </span><br><span class="line">            &#125;   </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(To &lt; params-&gt;ct[<span class="number">3</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                range = <span class="number">2</span>;            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                range = <span class="number">3</span>;            </span><br><span class="line">            &#125;      </span><br><span class="line">            </span><br><span class="line">            To = <span class="built_in">sqrt</span>(<span class="built_in">sqrt</span>(irData / (alphaCompensated * alphaCorrR[range] * (<span class="number">1</span> + params-&gt;ksTo[range] * (To - params-&gt;ct[range]))) + taTr)) - <span class="number">273.15</span>;</span><br><span class="line">                        </span><br><span class="line">            result[pixelNumber] = To;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">MLX90640_GetImage</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params, <span class="type">float</span> *result)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> vdd;</span><br><span class="line">    <span class="type">float</span> ta;</span><br><span class="line">    <span class="type">float</span> gain;</span><br><span class="line">    <span class="type">float</span> irDataCP[<span class="number">2</span>];</span><br><span class="line">    <span class="type">float</span> irData;</span><br><span class="line">    <span class="type">float</span> alphaCompensated;</span><br><span class="line">    <span class="type">uint8_t</span> mode;</span><br><span class="line">    <span class="type">int8_t</span> ilPattern;</span><br><span class="line">    <span class="type">int8_t</span> chessPattern;</span><br><span class="line">    <span class="type">int8_t</span> pattern;</span><br><span class="line">    <span class="type">int8_t</span> conversionPattern;</span><br><span class="line">    <span class="type">float</span> image;</span><br><span class="line">    <span class="type">uint16_t</span> subPage;</span><br><span class="line">    <span class="type">float</span> ktaScale;</span><br><span class="line">    <span class="type">float</span> kvScale;</span><br><span class="line">    <span class="type">float</span> kta;</span><br><span class="line">    <span class="type">float</span> kv;</span><br><span class="line">    </span><br><span class="line">    subPage = frameData[<span class="number">833</span>];</span><br><span class="line">    vdd = MLX90640_GetVdd(frameData, params);</span><br><span class="line">    ta = MLX90640_GetTa(frameData, params);</span><br><span class="line">    </span><br><span class="line">    ktaScale = POW2(params-&gt;ktaScale);</span><br><span class="line">    kvScale = POW2(params-&gt;kvScale);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//------------------------- Gain calculation -----------------------------------    </span></span><br><span class="line">    </span><br><span class="line">    gain = (<span class="type">float</span>)params-&gt;gainEE / (<span class="type">int16_t</span>)frameData[<span class="number">778</span>]; </span><br><span class="line">  </span><br><span class="line"><span class="comment">//------------------------- Image calculation -------------------------------------    </span></span><br><span class="line">    </span><br><span class="line">    mode = (frameData[<span class="number">832</span>] &amp; MLX90640_CTRL_MEAS_MODE_MASK) &gt;&gt; <span class="number">5</span>;</span><br><span class="line">    </span><br><span class="line">    irDataCP[<span class="number">0</span>] = (<span class="type">int16_t</span>)frameData[<span class="number">776</span>] * gain;</span><br><span class="line">    irDataCP[<span class="number">1</span>] = (<span class="type">int16_t</span>)frameData[<span class="number">808</span>] * gain;</span><br><span class="line">    </span><br><span class="line">    irDataCP[<span class="number">0</span>] = irDataCP[<span class="number">0</span>] - params-&gt;cpOffset[<span class="number">0</span>] * (<span class="number">1</span> + params-&gt;cpKta * (ta - <span class="number">25</span>)) * (<span class="number">1</span> + params-&gt;cpKv * (vdd - <span class="number">3.3</span>));</span><br><span class="line">    <span class="keyword">if</span>( mode ==  params-&gt;calibrationModeEE)</span><br><span class="line">    &#123;</span><br><span class="line">        irDataCP[<span class="number">1</span>] = irDataCP[<span class="number">1</span>] - params-&gt;cpOffset[<span class="number">1</span>] * (<span class="number">1</span> + params-&gt;cpKta * (ta - <span class="number">25</span>)) * (<span class="number">1</span> + params-&gt;cpKv * (vdd - <span class="number">3.3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      irDataCP[<span class="number">1</span>] = irDataCP[<span class="number">1</span>] - (params-&gt;cpOffset[<span class="number">1</span>] + params-&gt;ilChessC[<span class="number">0</span>]) * (<span class="number">1</span> + params-&gt;cpKta * (ta - <span class="number">25</span>)) * (<span class="number">1</span> + params-&gt;cpKv * (vdd - <span class="number">3.3</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> pixelNumber = <span class="number">0</span>; pixelNumber &lt; <span class="number">768</span>; pixelNumber++)</span><br><span class="line">    &#123;</span><br><span class="line">        ilPattern = pixelNumber / <span class="number">32</span> - (pixelNumber / <span class="number">64</span>) * <span class="number">2</span>; </span><br><span class="line">        chessPattern = ilPattern ^ (pixelNumber - (pixelNumber/<span class="number">2</span>)*<span class="number">2</span>); </span><br><span class="line">        conversionPattern = ((pixelNumber + <span class="number">2</span>) / <span class="number">4</span> - (pixelNumber + <span class="number">3</span>) / <span class="number">4</span> + (pixelNumber + <span class="number">1</span>) / <span class="number">4</span> - pixelNumber / <span class="number">4</span>) * (<span class="number">1</span> - <span class="number">2</span> * ilPattern);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(mode == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          pattern = ilPattern; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">          pattern = chessPattern; </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(pattern == frameData[<span class="number">833</span>])</span><br><span class="line">        &#123;    </span><br><span class="line">            irData = (<span class="type">int16_t</span>)frameData[pixelNumber] * gain;</span><br><span class="line">            </span><br><span class="line">            kta = params-&gt;kta[pixelNumber]/ktaScale;</span><br><span class="line">            kv = params-&gt;kv[pixelNumber]/kvScale;</span><br><span class="line">            irData = irData - params-&gt;offset[pixelNumber]*(<span class="number">1</span> + kta*(ta - <span class="number">25</span>))*(<span class="number">1</span> + kv*(vdd - <span class="number">3.3</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(mode !=  params-&gt;calibrationModeEE)</span><br><span class="line">            &#123;</span><br><span class="line">              irData = irData + params-&gt;ilChessC[<span class="number">2</span>] * (<span class="number">2</span> * ilPattern - <span class="number">1</span>) - params-&gt;ilChessC[<span class="number">1</span>] * conversionPattern; </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            irData = irData - params-&gt;tgc * irDataCP[subPage];</span><br><span class="line">                        </span><br><span class="line">            alphaCompensated = params-&gt;alpha[pixelNumber];</span><br><span class="line">            </span><br><span class="line">            image = irData*alphaCompensated;</span><br><span class="line">            </span><br><span class="line">            result[pixelNumber] = image;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">MLX90640_GetVdd</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> vdd;</span><br><span class="line">    <span class="type">float</span> resolutionCorrection;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> resolutionRAM;  </span><br><span class="line">    </span><br><span class="line">    resolutionRAM = (frameData[<span class="number">832</span>] &amp; ~MLX90640_CTRL_RESOLUTION_MASK) &gt;&gt; MLX90640_CTRL_RESOLUTION_SHIFT;   </span><br><span class="line">    resolutionCorrection = POW2(params-&gt;resolutionEE) / POW2(resolutionRAM);</span><br><span class="line">    vdd = (resolutionCorrection * (<span class="type">int16_t</span>)frameData[<span class="number">810</span>] - params-&gt;vdd25) / params-&gt;kVdd + <span class="number">3.3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vdd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">MLX90640_GetTa</span><span class="params">(<span class="type">uint16_t</span> *frameData, <span class="type">const</span> paramsMLX90640 *params)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int16_t</span> ptat;</span><br><span class="line">    <span class="type">float</span> ptatArt;</span><br><span class="line">    <span class="type">float</span> vdd;</span><br><span class="line">    <span class="type">float</span> ta;</span><br><span class="line">    </span><br><span class="line">    vdd = MLX90640_GetVdd(frameData, params);</span><br><span class="line">    </span><br><span class="line">    ptat = (<span class="type">int16_t</span>)frameData[<span class="number">800</span>];</span><br><span class="line">    </span><br><span class="line">    ptatArt = (ptat / (ptat * params-&gt;alphaPTAT + (<span class="type">int16_t</span>)frameData[<span class="number">768</span>])) * POW2(<span class="number">18</span>);</span><br><span class="line">    </span><br><span class="line">    ta = (ptatArt / (<span class="number">1</span> + params-&gt;KvPTAT * (vdd - <span class="number">3.3</span>)) - params-&gt;vPTAT25);</span><br><span class="line">    ta = ta / params-&gt;KtPTAT + <span class="number">25</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MLX90640_GetSubPageNumber</span><span class="params">(<span class="type">uint16_t</span> *frameData)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> frameData[<span class="number">833</span>];    </span><br><span class="line"></span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MLX90640_BadPixelsCorrection</span><span class="params">(<span class="type">uint16_t</span> *pixels, <span class="type">float</span> *to, <span class="type">int</span> mode, paramsMLX90640 *params)</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="type">float</span> ap[<span class="number">4</span>];</span><br><span class="line">    <span class="type">uint8_t</span> pix;</span><br><span class="line">    <span class="type">uint8_t</span> line;</span><br><span class="line">    <span class="type">uint8_t</span> column;</span><br><span class="line">    </span><br><span class="line">    pix = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(pixels[pix] != <span class="number">0xFFFF</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        line = pixels[pix]&gt;&gt;<span class="number">5</span>;</span><br><span class="line">        column = pixels[pix] - (line&lt;&lt;<span class="number">5</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(mode == <span class="number">1</span>)</span><br><span class="line">        &#123;        </span><br><span class="line">            <span class="keyword">if</span>(line == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(column == <span class="number">0</span>)</span><br><span class="line">                &#123;        </span><br><span class="line">                    to[pixels[pix]] = to[<span class="number">33</span>];                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(column == <span class="number">31</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    to[pixels[pix]] = to[<span class="number">62</span>];                      </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    to[pixels[pix]] = (to[pixels[pix]+<span class="number">31</span>] + to[pixels[pix]+<span class="number">33</span>])/<span class="number">2.0</span>;                    </span><br><span class="line">                &#125;        </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(line == <span class="number">23</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(column == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    to[pixels[pix]] = to[<span class="number">705</span>];                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(column == <span class="number">31</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    to[pixels[pix]] = to[<span class="number">734</span>];                       </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    to[pixels[pix]] = (to[pixels[pix]<span class="number">-33</span>] + to[pixels[pix]<span class="number">-31</span>])/<span class="number">2.0</span>;                       </span><br><span class="line">                &#125;                       </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(column == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                to[pixels[pix]] = (to[pixels[pix]<span class="number">-31</span>] + to[pixels[pix]+<span class="number">33</span>])/<span class="number">2.0</span>;                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(column == <span class="number">31</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                to[pixels[pix]] = (to[pixels[pix]<span class="number">-33</span>] + to[pixels[pix]+<span class="number">31</span>])/<span class="number">2.0</span>;                </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ap[<span class="number">0</span>] = to[pixels[pix]<span class="number">-33</span>];</span><br><span class="line">                ap[<span class="number">1</span>] = to[pixels[pix]<span class="number">-31</span>];</span><br><span class="line">                ap[<span class="number">2</span>] = to[pixels[pix]+<span class="number">31</span>];</span><br><span class="line">                ap[<span class="number">3</span>] = to[pixels[pix]+<span class="number">33</span>];</span><br><span class="line">                to[pixels[pix]] = GetMedian(ap,<span class="number">4</span>);</span><br><span class="line">            &#125;                   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;        </span><br><span class="line">            <span class="keyword">if</span>(column == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                to[pixels[pix]] = to[pixels[pix]+<span class="number">1</span>];            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(column == <span class="number">1</span> || column == <span class="number">30</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                to[pixels[pix]] = (to[pixels[pix]<span class="number">-1</span>]+to[pixels[pix]+<span class="number">1</span>])/<span class="number">2.0</span>;                </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(column == <span class="number">31</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                to[pixels[pix]] = to[pixels[pix]<span class="number">-1</span>];</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(IsPixelBad(pixels[pix]<span class="number">-2</span>,params) == <span class="number">0</span> &amp;&amp; IsPixelBad(pixels[pix]+<span class="number">2</span>,params) == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ap[<span class="number">0</span>] = to[pixels[pix]+<span class="number">1</span>] - to[pixels[pix]+<span class="number">2</span>];</span><br><span class="line">                    ap[<span class="number">1</span>] = to[pixels[pix]<span class="number">-1</span>] - to[pixels[pix]<span class="number">-2</span>];</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">fabs</span>(ap[<span class="number">0</span>]) &gt; <span class="built_in">fabs</span>(ap[<span class="number">1</span>]))</span><br><span class="line">                    &#123;</span><br><span class="line">                        to[pixels[pix]] = to[pixels[pix]<span class="number">-1</span>] + ap[<span class="number">1</span>];                        </span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        to[pixels[pix]] = to[pixels[pix]+<span class="number">1</span>] + ap[<span class="number">0</span>];                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    to[pixels[pix]] = (to[pixels[pix]<span class="number">-1</span>]+to[pixels[pix]+<span class="number">1</span>])/<span class="number">2.0</span>;                    </span><br><span class="line">                &#125;            </span><br><span class="line">            &#125;                      </span><br><span class="line">        &#125; </span><br><span class="line">        pix = pix + <span class="number">1</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractVDDParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int8_t</span> kVdd;</span><br><span class="line">    <span class="type">int16_t</span> vdd25;</span><br><span class="line">    </span><br><span class="line">    kVdd = MLX90640_MS_BYTE(eeData[<span class="number">51</span>]);</span><br><span class="line"></span><br><span class="line">    vdd25 = MLX90640_LS_BYTE(eeData[<span class="number">51</span>]);</span><br><span class="line">    vdd25 = ((vdd25 - <span class="number">256</span>) &lt;&lt; <span class="number">5</span>) - <span class="number">8192</span>;</span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;kVdd = <span class="number">32</span> * kVdd;</span><br><span class="line">    mlx90640-&gt;vdd25 = vdd25; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractPTATParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> KvPTAT;</span><br><span class="line">    <span class="type">float</span> KtPTAT;</span><br><span class="line">    <span class="type">int16_t</span> vPTAT25;</span><br><span class="line">    <span class="type">float</span> alphaPTAT;</span><br><span class="line">    </span><br><span class="line">    KvPTAT = (eeData[<span class="number">50</span>] &amp; MLX90640_MSBITS_6_MASK) &gt;&gt; <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">if</span>(KvPTAT &gt; <span class="number">31</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        KvPTAT = KvPTAT - <span class="number">64</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    KvPTAT = KvPTAT/<span class="number">4096</span>;</span><br><span class="line">    </span><br><span class="line">    KtPTAT = eeData[<span class="number">50</span>] &amp; MLX90640_LSBITS_10_MASK;</span><br><span class="line">    <span class="keyword">if</span>(KtPTAT &gt; <span class="number">511</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        KtPTAT = KtPTAT - <span class="number">1024</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    KtPTAT = KtPTAT/<span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    vPTAT25 = eeData[<span class="number">49</span>];</span><br><span class="line">    </span><br><span class="line">    alphaPTAT = (eeData[<span class="number">16</span>] &amp; MLX90640_NIBBLE4_MASK) / POW2(<span class="number">14</span>) + <span class="number">8.0f</span>;</span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;KvPTAT = KvPTAT;</span><br><span class="line">    mlx90640-&gt;KtPTAT = KtPTAT;    </span><br><span class="line">    mlx90640-&gt;vPTAT25 = vPTAT25;</span><br><span class="line">    mlx90640-&gt;alphaPTAT = alphaPTAT;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractGainParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    mlx90640-&gt;gainEE = (<span class="type">int16_t</span>)eeData[<span class="number">48</span>];;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractTgcParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    mlx90640-&gt;tgc = (<span class="type">int8_t</span>)MLX90640_LS_BYTE(eeData[<span class="number">60</span>]) / <span class="number">32.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractResolutionParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> resolutionEE;</span><br><span class="line">    resolutionEE = (eeData[<span class="number">56</span>] &amp; <span class="number">0x3000</span>) &gt;&gt; <span class="number">12</span>;    </span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;resolutionEE = resolutionEE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKsTaParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;   </span><br><span class="line">    mlx90640-&gt;KsTa = (<span class="type">int8_t</span>)MLX90640_MS_BYTE(eeData[<span class="number">60</span>]) / <span class="number">8192.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKsToParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> KsToScale;</span><br><span class="line">    <span class="type">int8_t</span> step;</span><br><span class="line">    </span><br><span class="line">    step = ((eeData[<span class="number">63</span>] &amp; <span class="number">0x3000</span>) &gt;&gt; <span class="number">12</span>) * <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;ct[<span class="number">0</span>] = <span class="number">-40</span>;</span><br><span class="line">    mlx90640-&gt;ct[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    mlx90640-&gt;ct[<span class="number">2</span>] = MLX90640_NIBBLE2(eeData[<span class="number">63</span>]);</span><br><span class="line">    mlx90640-&gt;ct[<span class="number">3</span>] = MLX90640_NIBBLE3(eeData[<span class="number">63</span>]);</span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;ct[<span class="number">2</span>] = mlx90640-&gt;ct[<span class="number">2</span>]*step;</span><br><span class="line">    mlx90640-&gt;ct[<span class="number">3</span>] = mlx90640-&gt;ct[<span class="number">2</span>] + mlx90640-&gt;ct[<span class="number">3</span>]*step;</span><br><span class="line">    mlx90640-&gt;ct[<span class="number">4</span>] = <span class="number">400</span>;</span><br><span class="line">    </span><br><span class="line">    KsToScale = MLX90640_NIBBLE1(eeData[<span class="number">63</span>]) + <span class="number">8</span>;</span><br><span class="line">    KsToScale = <span class="number">1UL</span> &lt;&lt; KsToScale;</span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;ksTo[<span class="number">0</span>] = (<span class="type">int8_t</span>)MLX90640_LS_BYTE(eeData[<span class="number">61</span>]) / (<span class="type">float</span>)KsToScale;</span><br><span class="line">    mlx90640-&gt;ksTo[<span class="number">1</span>] = (<span class="type">int8_t</span>)MLX90640_MS_BYTE(eeData[<span class="number">61</span>]) / (<span class="type">float</span>)KsToScale;</span><br><span class="line">    mlx90640-&gt;ksTo[<span class="number">2</span>] = (<span class="type">int8_t</span>)MLX90640_LS_BYTE(eeData[<span class="number">62</span>]) / (<span class="type">float</span>)KsToScale;</span><br><span class="line">    mlx90640-&gt;ksTo[<span class="number">3</span>] = (<span class="type">int8_t</span>)MLX90640_MS_BYTE(eeData[<span class="number">62</span>]) / (<span class="type">float</span>)KsToScale;</span><br><span class="line">    mlx90640-&gt;ksTo[<span class="number">4</span>] = <span class="number">-0.0002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractAlphaParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> accRow[<span class="number">24</span>];</span><br><span class="line">    <span class="type">int</span> accColumn[<span class="number">32</span>];</span><br><span class="line">    <span class="type">int</span> p = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> alphaRef;</span><br><span class="line">    <span class="type">uint8_t</span> alphaScale;</span><br><span class="line">    <span class="type">uint8_t</span> accRowScale;</span><br><span class="line">    <span class="type">uint8_t</span> accColumnScale;</span><br><span class="line">    <span class="type">uint8_t</span> accRemScale;</span><br><span class="line">    <span class="type">float</span> alphaTemp[<span class="number">768</span>];</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    accRemScale = MLX90640_NIBBLE1(eeData[<span class="number">32</span>]);</span><br><span class="line">    accColumnScale = MLX90640_NIBBLE2(eeData[<span class="number">32</span>]);</span><br><span class="line">    accRowScale = MLX90640_NIBBLE3(eeData[<span class="number">32</span>]);</span><br><span class="line">    alphaScale = MLX90640_NIBBLE4(eeData[<span class="number">32</span>]) + <span class="number">30</span>;</span><br><span class="line">    alphaRef = eeData[<span class="number">33</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p = i * <span class="number">4</span>;</span><br><span class="line">        accRow[p + <span class="number">0</span>] = MLX90640_NIBBLE1(eeData[<span class="number">34</span> + i]);</span><br><span class="line">        accRow[p + <span class="number">1</span>] = MLX90640_NIBBLE2(eeData[<span class="number">34</span> + i]);</span><br><span class="line">        accRow[p + <span class="number">2</span>] = MLX90640_NIBBLE3(eeData[<span class="number">34</span> + i]);</span><br><span class="line">        accRow[p + <span class="number">3</span>] = MLX90640_NIBBLE4(eeData[<span class="number">34</span> + i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_LINE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (accRow[i] &gt; <span class="number">7</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            accRow[i] = accRow[i] - <span class="number">16</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p = i * <span class="number">4</span>;</span><br><span class="line">        accColumn[p + <span class="number">0</span>] = MLX90640_NIBBLE1(eeData[<span class="number">40</span> + i]);</span><br><span class="line">        accColumn[p + <span class="number">1</span>] = MLX90640_NIBBLE2(eeData[<span class="number">40</span> + i]);</span><br><span class="line">        accColumn[p + <span class="number">2</span>] = MLX90640_NIBBLE3(eeData[<span class="number">40</span> + i]);</span><br><span class="line">        accColumn[p + <span class="number">3</span>] = MLX90640_NIBBLE4(eeData[<span class="number">40</span> + i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_COLUMN_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (accColumn[i] &gt; <span class="number">7</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            accColumn[i] = accColumn[i] - <span class="number">16</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_LINE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; MLX90640_COLUMN_NUM; j ++)</span><br><span class="line">        &#123;</span><br><span class="line">            p = <span class="number">32</span> * i +j;</span><br><span class="line">            alphaTemp[p] = (eeData[<span class="number">64</span> + p] &amp; <span class="number">0x03F0</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">if</span> (alphaTemp[p] &gt; <span class="number">31</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                alphaTemp[p] = alphaTemp[p] - <span class="number">64</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            alphaTemp[p] = alphaTemp[p]*(<span class="number">1</span> &lt;&lt; accRemScale);</span><br><span class="line">            alphaTemp[p] = (alphaRef + (accRow[i] &lt;&lt; accRowScale) + (accColumn[j] &lt;&lt; accColumnScale) + alphaTemp[p]);</span><br><span class="line">            alphaTemp[p] = alphaTemp[p] / POW2(alphaScale);</span><br><span class="line">            alphaTemp[p] = alphaTemp[p] - mlx90640-&gt;tgc * (mlx90640-&gt;cpAlpha[<span class="number">0</span>] + mlx90640-&gt;cpAlpha[<span class="number">1</span>])/<span class="number">2</span>;</span><br><span class="line">            alphaTemp[p] = SCALEALPHA/alphaTemp[p];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    temp = alphaTemp[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; MLX90640_PIXEL_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (alphaTemp[i] &gt; temp)</span><br><span class="line">        &#123;</span><br><span class="line">            temp = alphaTemp[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    alphaScale = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(temp &lt; <span class="number">32767.4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        temp = temp*<span class="number">2</span>;</span><br><span class="line">        alphaScale = alphaScale + <span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_PIXEL_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        temp = alphaTemp[i] * POW2(alphaScale);        </span><br><span class="line">        mlx90640-&gt;alpha[i] = (temp + <span class="number">0.5</span>);        </span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;alphaScale = alphaScale;      </span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractOffsetParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> occRow[<span class="number">24</span>];</span><br><span class="line">    <span class="type">int</span> occColumn[<span class="number">32</span>];</span><br><span class="line">    <span class="type">int</span> p = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int16_t</span> offsetRef;</span><br><span class="line">    <span class="type">uint8_t</span> occRowScale;</span><br><span class="line">    <span class="type">uint8_t</span> occColumnScale;</span><br><span class="line">    <span class="type">uint8_t</span> occRemScale;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    occRemScale = MLX90640_NIBBLE1(eeData[<span class="number">16</span>]);</span><br><span class="line">    occColumnScale = MLX90640_NIBBLE2(eeData[<span class="number">16</span>]);</span><br><span class="line">    occRowScale = MLX90640_NIBBLE3(eeData[<span class="number">16</span>]);</span><br><span class="line">    offsetRef = (<span class="type">int16_t</span>)eeData[<span class="number">17</span>];</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p = i * <span class="number">4</span>;</span><br><span class="line">        occRow[p + <span class="number">0</span>] = MLX90640_NIBBLE1(eeData[<span class="number">18</span> + i]);</span><br><span class="line">        occRow[p + <span class="number">1</span>] = MLX90640_NIBBLE2(eeData[<span class="number">18</span> + i]);</span><br><span class="line">        occRow[p + <span class="number">2</span>] = MLX90640_NIBBLE3(eeData[<span class="number">18</span> + i]);</span><br><span class="line">        occRow[p + <span class="number">3</span>] = MLX90640_NIBBLE4(eeData[<span class="number">18</span> + i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_LINE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (occRow[i] &gt; <span class="number">7</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            occRow[i] = occRow[i] - <span class="number">16</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p = i * <span class="number">4</span>;</span><br><span class="line">        occColumn[p + <span class="number">0</span>] = MLX90640_NIBBLE1(eeData[<span class="number">24</span> + i]);</span><br><span class="line">        occColumn[p + <span class="number">1</span>] = MLX90640_NIBBLE2(eeData[<span class="number">24</span> + i]);</span><br><span class="line">        occColumn[p + <span class="number">2</span>] = MLX90640_NIBBLE3(eeData[<span class="number">24</span> + i]);</span><br><span class="line">        occColumn[p + <span class="number">3</span>] = MLX90640_NIBBLE4(eeData[<span class="number">24</span> + i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_COLUMN_NUM; i ++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (occColumn[i] &gt; <span class="number">7</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            occColumn[i] = occColumn[i] - <span class="number">16</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_LINE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; MLX90640_COLUMN_NUM; j ++)</span><br><span class="line">        &#123;</span><br><span class="line">            p = <span class="number">32</span> * i +j;</span><br><span class="line">            mlx90640-&gt;offset[p] = (eeData[<span class="number">64</span> + p] &amp; MLX90640_MSBITS_6_MASK) &gt;&gt; <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">if</span> (mlx90640-&gt;offset[p] &gt; <span class="number">31</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mlx90640-&gt;offset[p] = mlx90640-&gt;offset[p] - <span class="number">64</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mlx90640-&gt;offset[p] = mlx90640-&gt;offset[p]*(<span class="number">1</span> &lt;&lt; occRemScale);</span><br><span class="line">            mlx90640-&gt;offset[p] = (offsetRef + (occRow[i] &lt;&lt; occRowScale) + (occColumn[j] &lt;&lt; occColumnScale) + mlx90640-&gt;offset[p]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKtaPixelParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> p = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int8_t</span> KtaRC[<span class="number">4</span>];</span><br><span class="line">    <span class="type">uint8_t</span> ktaScale1;</span><br><span class="line">    <span class="type">uint8_t</span> ktaScale2;</span><br><span class="line">    <span class="type">uint8_t</span> split;</span><br><span class="line">    <span class="type">float</span> ktaTemp[<span class="number">768</span>];</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line">    </span><br><span class="line">    KtaRC[<span class="number">0</span>] = (<span class="type">int8_t</span>)MLX90640_MS_BYTE(eeData[<span class="number">54</span>]);;</span><br><span class="line">    KtaRC[<span class="number">2</span>] = (<span class="type">int8_t</span>)MLX90640_LS_BYTE(eeData[<span class="number">54</span>]);;</span><br><span class="line">    KtaRC[<span class="number">1</span>] = (<span class="type">int8_t</span>)MLX90640_MS_BYTE(eeData[<span class="number">55</span>]);;</span><br><span class="line">    KtaRC[<span class="number">3</span>] = (<span class="type">int8_t</span>)MLX90640_LS_BYTE(eeData[<span class="number">55</span>]);;</span><br><span class="line">      </span><br><span class="line">    ktaScale1 = MLX90640_NIBBLE2(eeData[<span class="number">56</span>]) + <span class="number">8</span>;</span><br><span class="line">    ktaScale2 = MLX90640_NIBBLE1(eeData[<span class="number">56</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_LINE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; MLX90640_COLUMN_NUM; j ++)</span><br><span class="line">        &#123;</span><br><span class="line">            p = <span class="number">32</span> * i +j;</span><br><span class="line">            split = <span class="number">2</span>*(p/<span class="number">32</span> - (p/<span class="number">64</span>)*<span class="number">2</span>) + p%<span class="number">2</span>;</span><br><span class="line">            ktaTemp[p] = (eeData[<span class="number">64</span> + p] &amp; <span class="number">0x000E</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (ktaTemp[p] &gt; <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ktaTemp[p] = ktaTemp[p] - <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ktaTemp[p] = ktaTemp[p] * (<span class="number">1</span> &lt;&lt; ktaScale2);</span><br><span class="line">            ktaTemp[p] = KtaRC[split] + ktaTemp[p];</span><br><span class="line">            ktaTemp[p] = ktaTemp[p] / POW2(ktaScale1);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    temp = <span class="built_in">fabs</span>(ktaTemp[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; MLX90640_PIXEL_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(ktaTemp[i]) &gt; temp)</span><br><span class="line">        &#123;</span><br><span class="line">            temp = <span class="built_in">fabs</span>(ktaTemp[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ktaScale1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(temp &lt; <span class="number">63.4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        temp = temp*<span class="number">2</span>;</span><br><span class="line">        ktaScale1 = ktaScale1 + <span class="number">1</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_PIXEL_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        temp = ktaTemp[i] * POW2(ktaScale1);</span><br><span class="line">        <span class="keyword">if</span> (temp &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mlx90640-&gt;kta[i] = (temp - <span class="number">0.5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mlx90640-&gt;kta[i] = (temp + <span class="number">0.5</span>);</span><br><span class="line">        &#125;        </span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;ktaScale = ktaScale1;           </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractKvPixelParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> p = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int8_t</span> KvT[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int8_t</span> KvRoCo;</span><br><span class="line">    <span class="type">int8_t</span> KvRoCe;</span><br><span class="line">    <span class="type">int8_t</span> KvReCo;</span><br><span class="line">    <span class="type">int8_t</span> KvReCe;</span><br><span class="line">    <span class="type">uint8_t</span> kvScale;</span><br><span class="line">    <span class="type">uint8_t</span> split;</span><br><span class="line">    <span class="type">float</span> kvTemp[<span class="number">768</span>];</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line"></span><br><span class="line">    KvRoCo = MLX90640_NIBBLE4(eeData[<span class="number">52</span>]);</span><br><span class="line">    <span class="keyword">if</span> (KvRoCo &gt; <span class="number">7</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        KvRoCo = KvRoCo - <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    KvT[<span class="number">0</span>] = KvRoCo;</span><br><span class="line">    </span><br><span class="line">    KvReCo = MLX90640_NIBBLE3(eeData[<span class="number">52</span>]);</span><br><span class="line">    <span class="keyword">if</span> (KvReCo &gt; <span class="number">7</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        KvReCo = KvReCo - <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    KvT[<span class="number">2</span>] = KvReCo;</span><br><span class="line">      </span><br><span class="line">    KvRoCe = MLX90640_NIBBLE2(eeData[<span class="number">52</span>]);</span><br><span class="line">    <span class="keyword">if</span> (KvRoCe &gt; <span class="number">7</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        KvRoCe = KvRoCe - <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    KvT[<span class="number">1</span>] = KvRoCe;</span><br><span class="line">      </span><br><span class="line">    KvReCe = MLX90640_NIBBLE1(eeData[<span class="number">52</span>]);</span><br><span class="line">    <span class="keyword">if</span> (KvReCe &gt; <span class="number">7</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        KvReCe = KvReCe - <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    KvT[<span class="number">3</span>] = KvReCe;</span><br><span class="line">  </span><br><span class="line">    kvScale = MLX90640_NIBBLE3(eeData[<span class="number">56</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_LINE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; MLX90640_COLUMN_NUM; j ++)</span><br><span class="line">        &#123;</span><br><span class="line">            p = <span class="number">32</span> * i +j;</span><br><span class="line">            split = <span class="number">2</span>*(p/<span class="number">32</span> - (p/<span class="number">64</span>)*<span class="number">2</span>) + p%<span class="number">2</span>;</span><br><span class="line">            kvTemp[p] = KvT[split];</span><br><span class="line">            kvTemp[p] = kvTemp[p] / POW2(kvScale);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    temp = <span class="built_in">fabs</span>(kvTemp[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; MLX90640_PIXEL_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(kvTemp[i]) &gt; temp)</span><br><span class="line">        &#123;</span><br><span class="line">            temp = <span class="built_in">fabs</span>(kvTemp[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kvScale = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(temp &lt; <span class="number">63.4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        temp = temp*<span class="number">2</span>;</span><br><span class="line">        kvScale = kvScale + <span class="number">1</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MLX90640_PIXEL_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        temp = kvTemp[i] * POW2(kvScale);</span><br><span class="line">        <span class="keyword">if</span> (temp &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mlx90640-&gt;kv[i] = (temp - <span class="number">0.5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mlx90640-&gt;kv[i] = (temp + <span class="number">0.5</span>);</span><br><span class="line">        &#125;        </span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;kvScale = kvScale;        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractCPParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> alphaSP[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int16_t</span> offsetSP[<span class="number">2</span>];</span><br><span class="line">    <span class="type">float</span> cpKv;</span><br><span class="line">    <span class="type">float</span> cpKta;</span><br><span class="line">    <span class="type">uint8_t</span> alphaScale;</span><br><span class="line">    <span class="type">uint8_t</span> ktaScale1;</span><br><span class="line">    <span class="type">uint8_t</span> kvScale;</span><br><span class="line"></span><br><span class="line">    alphaScale = MLX90640_NIBBLE4(eeData[<span class="number">32</span>]) + <span class="number">27</span>;</span><br><span class="line">    </span><br><span class="line">    offsetSP[<span class="number">0</span>] = (eeData[<span class="number">58</span>] &amp; MLX90640_LSBITS_10_MASK);</span><br><span class="line">    <span class="keyword">if</span> (offsetSP[<span class="number">0</span>] &gt; <span class="number">511</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        offsetSP[<span class="number">0</span>] = offsetSP[<span class="number">0</span>] - <span class="number">1024</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    offsetSP[<span class="number">1</span>] = (eeData[<span class="number">58</span>] &amp; MLX90640_MSBITS_6_MASK) &gt;&gt; <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">if</span> (offsetSP[<span class="number">1</span>] &gt; <span class="number">31</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        offsetSP[<span class="number">1</span>] = offsetSP[<span class="number">1</span>] - <span class="number">64</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    offsetSP[<span class="number">1</span>] = offsetSP[<span class="number">1</span>] + offsetSP[<span class="number">0</span>]; </span><br><span class="line">    </span><br><span class="line">    alphaSP[<span class="number">0</span>] = (eeData[<span class="number">57</span>] &amp; MLX90640_LSBITS_10_MASK);</span><br><span class="line">    <span class="keyword">if</span> (alphaSP[<span class="number">0</span>] &gt; <span class="number">511</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        alphaSP[<span class="number">0</span>] = alphaSP[<span class="number">0</span>] - <span class="number">1024</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    alphaSP[<span class="number">0</span>] = alphaSP[<span class="number">0</span>] /  POW2(alphaScale);</span><br><span class="line">    </span><br><span class="line">    alphaSP[<span class="number">1</span>] = (eeData[<span class="number">57</span>] &amp; MLX90640_MSBITS_6_MASK) &gt;&gt; <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">if</span> (alphaSP[<span class="number">1</span>] &gt; <span class="number">31</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        alphaSP[<span class="number">1</span>] = alphaSP[<span class="number">1</span>] - <span class="number">64</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    alphaSP[<span class="number">1</span>] = (<span class="number">1</span> + alphaSP[<span class="number">1</span>]/<span class="number">128</span>) * alphaSP[<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    cpKta = (<span class="type">int8_t</span>)MLX90640_LS_BYTE(eeData[<span class="number">59</span>]);</span><br><span class="line">    </span><br><span class="line">    ktaScale1 = MLX90640_NIBBLE2(eeData[<span class="number">56</span>]) + <span class="number">8</span>;    </span><br><span class="line">    mlx90640-&gt;cpKta = cpKta / POW2(ktaScale1);</span><br><span class="line">    </span><br><span class="line">    cpKv = (<span class="type">int8_t</span>)MLX90640_MS_BYTE(eeData[<span class="number">59</span>]);</span><br><span class="line">    </span><br><span class="line">    kvScale = MLX90640_NIBBLE3(eeData[<span class="number">56</span>]);</span><br><span class="line">    mlx90640-&gt;cpKv = cpKv / POW2(kvScale);</span><br><span class="line">       </span><br><span class="line">    mlx90640-&gt;cpAlpha[<span class="number">0</span>] = alphaSP[<span class="number">0</span>];</span><br><span class="line">    mlx90640-&gt;cpAlpha[<span class="number">1</span>] = alphaSP[<span class="number">1</span>];</span><br><span class="line">    mlx90640-&gt;cpOffset[<span class="number">0</span>] = offsetSP[<span class="number">0</span>];</span><br><span class="line">    mlx90640-&gt;cpOffset[<span class="number">1</span>] = offsetSP[<span class="number">1</span>];  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ExtractCILCParameters</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> ilChessC[<span class="number">3</span>];</span><br><span class="line">    <span class="type">uint8_t</span> calibrationModeEE;</span><br><span class="line">    </span><br><span class="line">    calibrationModeEE = (eeData[<span class="number">10</span>] &amp; <span class="number">0x0800</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    calibrationModeEE = calibrationModeEE ^ <span class="number">0x80</span>;</span><br><span class="line"></span><br><span class="line">    ilChessC[<span class="number">0</span>] = (eeData[<span class="number">53</span>] &amp; <span class="number">0x003F</span>);</span><br><span class="line">    <span class="keyword">if</span> (ilChessC[<span class="number">0</span>] &gt; <span class="number">31</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ilChessC[<span class="number">0</span>] = ilChessC[<span class="number">0</span>] - <span class="number">64</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ilChessC[<span class="number">0</span>] = ilChessC[<span class="number">0</span>] / <span class="number">16.0f</span>;</span><br><span class="line">    </span><br><span class="line">    ilChessC[<span class="number">1</span>] = (eeData[<span class="number">53</span>] &amp; <span class="number">0x07C0</span>) &gt;&gt; <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">if</span> (ilChessC[<span class="number">1</span>] &gt; <span class="number">15</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ilChessC[<span class="number">1</span>] = ilChessC[<span class="number">1</span>] - <span class="number">32</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ilChessC[<span class="number">1</span>] = ilChessC[<span class="number">1</span>] / <span class="number">2.0f</span>;</span><br><span class="line">    </span><br><span class="line">    ilChessC[<span class="number">2</span>] = (eeData[<span class="number">53</span>] &amp; <span class="number">0xF800</span>) &gt;&gt; <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">if</span> (ilChessC[<span class="number">2</span>] &gt; <span class="number">15</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ilChessC[<span class="number">2</span>] = ilChessC[<span class="number">2</span>] - <span class="number">32</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ilChessC[<span class="number">2</span>] = ilChessC[<span class="number">2</span>] / <span class="number">8.0f</span>;</span><br><span class="line">    </span><br><span class="line">    mlx90640-&gt;calibrationModeEE = calibrationModeEE;</span><br><span class="line">    mlx90640-&gt;ilChessC[<span class="number">0</span>] = ilChessC[<span class="number">0</span>];</span><br><span class="line">    mlx90640-&gt;ilChessC[<span class="number">1</span>] = ilChessC[<span class="number">1</span>];</span><br><span class="line">    mlx90640-&gt;ilChessC[<span class="number">2</span>] = ilChessC[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ExtractDeviatingPixels</span><span class="params">(<span class="type">uint16_t</span> *eeData, paramsMLX90640 *mlx90640)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> pixCnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint16_t</span> brokenPixCnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint16_t</span> outlierPixCnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> warn = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(pixCnt = <span class="number">0</span>; pixCnt&lt;<span class="number">5</span>; pixCnt++)</span><br><span class="line">    &#123;</span><br><span class="line">        mlx90640-&gt;brokenPixels[pixCnt] = <span class="number">0xFFFF</span>;</span><br><span class="line">        mlx90640-&gt;outlierPixels[pixCnt] = <span class="number">0xFFFF</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    pixCnt = <span class="number">0</span>;    </span><br><span class="line">    <span class="keyword">while</span> (pixCnt &lt; MLX90640_PIXEL_NUM &amp;&amp; brokenPixCnt &lt; <span class="number">5</span> &amp;&amp; outlierPixCnt &lt; <span class="number">5</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(eeData[pixCnt+<span class="number">64</span>] == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mlx90640-&gt;brokenPixels[brokenPixCnt] = pixCnt;</span><br><span class="line">            brokenPixCnt = brokenPixCnt + <span class="number">1</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>((eeData[pixCnt+<span class="number">64</span>] &amp; <span class="number">0x0001</span>) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mlx90640-&gt;outlierPixels[outlierPixCnt] = pixCnt;</span><br><span class="line">            outlierPixCnt = outlierPixCnt + <span class="number">1</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        </span><br><span class="line">        pixCnt = pixCnt + <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(brokenPixCnt &gt; <span class="number">4</span>)  </span><br><span class="line">    &#123;</span><br><span class="line">        warn = -MLX90640_BROKEN_PIXELS_NUM_ERROR;</span><br><span class="line">    &#125;         </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(outlierPixCnt &gt; <span class="number">4</span>)  </span><br><span class="line">    &#123;</span><br><span class="line">        warn = -MLX90640_OUTLIER_PIXELS_NUM_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((brokenPixCnt + outlierPixCnt) &gt; <span class="number">4</span>)  </span><br><span class="line">    &#123;</span><br><span class="line">        warn = -MLX90640_BAD_PIXELS_NUM_ERROR;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(pixCnt=<span class="number">0</span>; pixCnt&lt;brokenPixCnt; pixCnt++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(i=pixCnt+<span class="number">1</span>; i&lt;brokenPixCnt; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                warn = CheckAdjacentPixels(mlx90640-&gt;brokenPixels[pixCnt],mlx90640-&gt;brokenPixels[i]);</span><br><span class="line">                <span class="keyword">if</span>(warn != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> warn;</span><br><span class="line">                &#125;    </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(pixCnt=<span class="number">0</span>; pixCnt&lt;outlierPixCnt; pixCnt++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(i=pixCnt+<span class="number">1</span>; i&lt;outlierPixCnt; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                warn = CheckAdjacentPixels(mlx90640-&gt;outlierPixels[pixCnt],mlx90640-&gt;outlierPixels[i]);</span><br><span class="line">                <span class="keyword">if</span>(warn != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> warn;</span><br><span class="line">                &#125;    </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(pixCnt=<span class="number">0</span>; pixCnt&lt;brokenPixCnt; pixCnt++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;outlierPixCnt; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                warn = CheckAdjacentPixels(mlx90640-&gt;brokenPixels[pixCnt],mlx90640-&gt;outlierPixels[i]);</span><br><span class="line">                <span class="keyword">if</span>(warn != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> warn;</span><br><span class="line">                &#125;    </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;    </span><br><span class="line">        </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> warn;</span><br><span class="line">       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"> <span class="type">static</span> <span class="type">int</span> <span class="title function_">CheckAdjacentPixels</span><span class="params">(<span class="type">uint16_t</span> pix1, <span class="type">uint16_t</span> pix2)</span></span><br><span class="line"> &#123;</span><br><span class="line">     </span><br><span class="line">     <span class="type">int</span> pixPosDif;</span><br><span class="line">     <span class="type">uint16_t</span> lp1 = pix1 &gt;&gt; <span class="number">5</span>;</span><br><span class="line">     <span class="type">uint16_t</span> lp2 = pix2 &gt;&gt; <span class="number">5</span>;</span><br><span class="line">     <span class="type">uint16_t</span> cp1 = pix1 - (lp1 &lt;&lt; <span class="number">5</span>);</span><br><span class="line">     <span class="type">uint16_t</span> cp2 = pix2 - (lp2 &lt;&lt; <span class="number">5</span>);</span><br><span class="line">     </span><br><span class="line">     pixPosDif = lp1 - lp2;</span><br><span class="line">     <span class="keyword">if</span>(pixPosDif &gt; <span class="number">-2</span> &amp;&amp; pixPosDif &lt; <span class="number">2</span>)</span><br><span class="line">     &#123;</span><br><span class="line">        pixPosDif = cp1 - cp2;</span><br><span class="line">        <span class="keyword">if</span>(pixPosDif &gt; <span class="number">-2</span> &amp;&amp; pixPosDif &lt; <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-6</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">     &#125; </span><br><span class="line">      </span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">float</span> <span class="title function_">GetMedian</span><span class="params">(<span class="type">float</span> *values, <span class="type">int</span> n)</span></span><br><span class="line"> &#123;</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;n<span class="number">-1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i+<span class="number">1</span>; j&lt;n; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(values[j] &lt; values[i]) </span><br><span class="line">            &#123;                </span><br><span class="line">                temp = values[i];</span><br><span class="line">                values[i] = values[j];</span><br><span class="line">                values[j] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(n%<span class="number">2</span>==<span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ((values[n/<span class="number">2</span>] + values[n/<span class="number">2</span> - <span class="number">1</span>]) / <span class="number">2.0</span>);</span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> values[n/<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> &#125;           </span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">IsPixelBad</span><span class="params">(<span class="type">uint16_t</span> pixel,paramsMLX90640 *params)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(pixel == params-&gt;outlierPixels[i] || pixel == params-&gt;brokenPixels[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     </span><br><span class="line">&#125;     </span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://jianghe-jnhe.github.io/2024/10/04/MLX90640/" title="MLX90640中文API" target="_blank" rel="external">https://jianghe-jnhe.github.io/2024/10/04/MLX90640/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/jianghe-jnhe" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/jianghe-jnhe" target="_blank"><span class="text-dark">JiangHe</span><small class="ml-1x">Student</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2024/10/10/make-cmake/" title="make cmake"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2024/10/01/ProcessandThread/" title="003-进程与线程"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/jianghe-jnhe" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://space.bilibili.com/496375938" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        &copy; 2025 Jnhe
        
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>